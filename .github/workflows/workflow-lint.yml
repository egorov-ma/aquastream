---
name: Lint Infrastructure

'on':
  push:
    branches: [main, develop]
    paths:
      - '.github/workflows/**'
      - 'infra/**'
      - '*.sh'
  pull_request:
    paths:
      - '.github/workflows/**'
      - 'infra/**'
      - '*.sh'

permissions:
  contents: read
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  actionlint:
    name: Lint GitHub Actions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: rhysd/actionlint@v1.7.7

  infrastructure-lint:
    name: Lint Infrastructure Files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install linting tools
        run: |
          # yq –¥–ª—è YAML
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          
          # Install shellcheck for validating shell scripts
          sudo apt-get update
          sudo apt-get install -y shellcheck
          
          # hadolint –¥–ª—è Dockerfile
          sudo wget -qO /usr/local/bin/hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
          sudo chmod +x /usr/local/bin/hadolint

      - name: Lint YAML files
        run: |
          echo "üìÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ YAML —Ñ–∞–π–ª–æ–≤..."
          find infra -name "*.yml" -o -name "*.yaml" | while read -r yaml_file; do
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞: $yaml_file"
            yq eval '.' "$yaml_file" > /dev/null
          done

      - name: Lint shell scripts
        run: |
          echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ shell —Å–∫—Ä–∏–ø—Ç–æ–≤..."
          find . -name "*.sh" -not -path "./node_modules/*" | while read -r script; do
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞: $script"
            shellcheck -x "$script"
          done

      - name: Lint Dockerfiles
        run: |
          echo "üê≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ Dockerfile —Ñ–∞–π–ª–æ–≤..."
          find infra/docker/images -name "Dockerfile.*" | while read -r dockerfile; do
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞: $dockerfile"
            hadolint "$dockerfile"
          done

      - name: Quick infrastructure validation
        run: |
          echo "‚ö° –ë—ã—Å—Ç—Ä–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã..."
          if [ -f "infra/scripts/validate-infrastructure.sh" ]; then
            chmod +x infra/scripts/validate-infrastructure.sh
            ./infra/scripts/validate-infrastructure.sh --quick || echo "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏"
          fi
