---
name: Deploy
permissions:
  contents: read
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

'on':
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'infra/**'
      - 'run.sh'

env:
  # Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ CI
  POSTGRES_PASSWORD: ci_test_password_123
  ELASTIC_PASSWORD: ci_test_elastic_123
  KIBANA_PASSWORD: ci_test_kibana_123
  GRAFANA_ADMIN_PASSWORD: ci_test_grafana_123

jobs:
  validate-infrastructure:
    name: Validate Infrastructure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install validation tools
        run: |
          # yq Ð´Ð»Ñ YAML Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          
          # shellcheck Ð´Ð»Ñ shell ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð²
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Create test .env file
        run: |
          cat > infra/docker/compose/.env << EOF
          POSTGRES_PASSWORD=ci_test_password_123
          ELASTIC_PASSWORD=ci_test_elastic_123
          KIBANA_PASSWORD=ci_test_kibana_123
          GRAFANA_ADMIN_PASSWORD=ci_test_grafana_123
          NGINX_HTTP_PORT=80
          NGINX_HTTPS_PORT=443
          POSTGRES_PORT=5432
          KAFKA_HOST_PORT=19092
          NGINX_TAG=1.25-alpine
          POSTGRES_TAG=15-alpine
          ELASTIC_TAG=8.9.0
          LOGSTASH_TAG=8.9.0
          KIBANA_TAG=8.9.0
          KAFKA_TAG=7.4.1
          ZOOKEEPER_TAG=3.8
          PROM_TAG=v2.45.0
          GRAFANA_TAG=10.0.3
          NODE_TAG=18-alpine
          ALPINE_TAG=3.19.1
          ECLIPSE_TEMURIN_JDK_TAG=21-jdk
          ECLIPSE_TEMURIN_JRE_TAG=21-jre
          LOGSTASH_HOST=logstash
          LOGSTASH_PORT=5000
          CPU_MICRO=0.05
          MEM_MICRO=64M
          CPU_TINY=0.15
          MEM_TINY=192M
          CPU_SMALL=0.3
          MEM_SMALL=384M
          CPU_MEDIUM=0.6
          MEM_MEDIUM=768M
          CPU_BIG=0.8
          MEM_BIG=1536M
          EOF

      - name: Validate Docker Compose
        run: |
          echo "ðŸ³ Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Docker Compose..."
          docker compose -f infra/docker/compose/docker-compose.yml config > /dev/null
          echo "âœ… Docker Compose ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð²Ð°Ð»Ð¸Ð´Ð½Ð°"

      - name: Check for latest tags
        run: |
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° :latest Ñ‚ÐµÐ³Ð¸..."
          if grep -q ":latest" infra/docker/compose/docker-compose.yml; then
            echo "âŒ ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ :latest Ñ‚ÐµÐ³Ð¸!"
            exit 1
          fi
          echo "âœ… Ð’ÑÐµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ Ð¸Ð¼ÐµÑŽÑ‚ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ Ð²ÐµÑ€ÑÐ¸Ð¸"

      - name: Validate shell scripts
        run: |
          echo "ðŸ”§ Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ shell ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð²..."
          find . -name "*.sh" -not -path "./node_modules/*" | while read script; do
            echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°: $script"
            shellcheck -x "$script" || echo "âš ï¸ ÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ñ Ð² $script"
          done

      - name: Run infrastructure validation
        run: |
          echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸ Ð¸Ð½Ñ„Ñ€Ð°ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹..."
          chmod +x infra/scripts/validate-infrastructure.sh
          ./infra/scripts/validate-infrastructure.sh --quick

  deploy:
    needs: validate-infrastructure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create production .env file
        run: |
          # Ð’ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÐµÐºÑ€ÐµÑ‚Ñ‹ GitHub
          cat > infra/docker/compose/.env << EOF
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD || 'changeme123!' }}
          ELASTIC_PASSWORD=${{ secrets.ELASTIC_PASSWORD || 'changeMe123!' }}
          KIBANA_PASSWORD=${{ secrets.KIBANA_PASSWORD || 'changeme123!' }}
          GRAFANA_ADMIN_PASSWORD=${{ secrets.GRAFANA_ADMIN_PASSWORD || 'admin' }}
          NGINX_HTTP_PORT=80
          NGINX_HTTPS_PORT=443
          POSTGRES_PORT=5432
          KAFKA_HOST_PORT=19092
          NGINX_TAG=1.25-alpine
          POSTGRES_TAG=15-alpine
          ELASTIC_TAG=8.9.0
          LOGSTASH_TAG=8.9.0
          KIBANA_TAG=8.9.0
          KAFKA_TAG=7.4.1
          ZOOKEEPER_TAG=3.8
          PROM_TAG=v2.45.0
          GRAFANA_TAG=10.0.3
          NODE_TAG=18-alpine
          ALPINE_TAG=3.19.1
          ECLIPSE_TEMURIN_JDK_TAG=21-jdk
          ECLIPSE_TEMURIN_JRE_TAG=21-jre
          LOGSTASH_HOST=logstash
          LOGSTASH_PORT=5000
          CPU_MICRO=0.05
          MEM_MICRO=64M
          CPU_TINY=0.15
          MEM_TINY=192M
          CPU_SMALL=0.3
          MEM_SMALL=384M
          CPU_MEDIUM=0.6
          MEM_MEDIUM=768M
          CPU_BIG=0.8
          MEM_BIG=1536M
          EOF

      - name: Build images defined in docker-compose
        run: docker compose -f infra/docker/compose/docker-compose.yml build

      # Ð·Ð´ÐµÑÑŒ Ð±ÑƒÐ´ÐµÑ‚ Ð¿ÑƒÑˆ Ð² registry Ð¸ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€.
      - name: Deploy placeholder
        run: echo "ðŸš€ Deployment step (placeholder)"
