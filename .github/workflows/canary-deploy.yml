name: Canary Deployment

on:
  push:
    branches: [ canary/* ]
  workflow_dispatch:
    inputs:
      canary_version:
        description: '–í–µ—Ä—Å–∏—è –¥–ª—è –∫–∞–Ω–∞—Ä–µ–µ—á–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è (–Ω–∞–ø—Ä–∏–º–µ—Ä 1.2.3)'
        required: true
      traffic_percentage:
        description: '–ü—Ä–æ—Ü–µ–Ω—Ç —Ç—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ –∫–∞–Ω–∞—Ä–µ–µ—á–Ω—É—é –≤–µ—Ä—Å–∏—é (1-100)'
        required: true
        default: '10'
      test_endpoints:
        description: '–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)'
        required: false
        default: '/api/health,/api/users/me'
      enable_alerts:
        description: '–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è'
        required: false
        default: true
        type: boolean

env:
  CANARY_VERSION: ${{ github.event.inputs.canary_version || github.ref_name }}
  TRAFFIC_PERCENTAGE: ${{ github.event.inputs.traffic_percentage || '10' }}
  TEST_ENDPOINTS: ${{ github.event.inputs.test_endpoints || '/api/health,/api/users/me' }}
  ENABLE_ALERTS: ${{ github.event.inputs.enable_alerts || 'true' }}
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
  REGISTRY: registry.example.com

jobs:
  prepare:
    name: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∫–∞–Ω–∞—Ä–µ–µ—á–Ω–æ–º—É –¥–µ–ø–ª–æ—é
    runs-on: ubuntu-latest
    outputs:
      canary_version: ${{ steps.extract_version.outputs.version }}
    steps:
      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        run: |
          echo "–ö–∞–Ω–∞—Ä–µ–µ—á–Ω–∞—è –≤–µ—Ä—Å–∏—è: $CANARY_VERSION"
          echo "–ü—Ä–æ—Ü–µ–Ω—Ç —Ç—Ä–∞—Ñ–∏–∫–∞: $TRAFFIC_PERCENTAGE"
          echo "–¢–µ—Å—Ç–∏—Ä—É–µ–º—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã: $TEST_ENDPOINTS"
          echo "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è: $ENABLE_ALERTS"
      
      - name: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –≤–µ—Ç–∫–∏
        id: extract_version
        run: |
          if [[ "$CANARY_VERSION" == canary/* ]]; then
            VERSION="${CANARY_VERSION#canary/}"
          else
            VERSION="$CANARY_VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "–ò–∑–≤–ª–µ—á–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è: $VERSION"

  build:
    name: –°–±–æ—Ä–∫–∞ –∫–∞–Ω–∞—Ä–µ–µ—á–Ω–æ–π –≤–µ—Ä—Å–∏–∏
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout –∫–æ–¥–∞
        uses: actions/checkout@v4
        
      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
          
      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
          
      - name: –°–±–æ—Ä–∫–∞ –∫–∞–Ω–∞—Ä–µ–µ—á–Ω–æ–π –≤–µ—Ä—Å–∏–∏
        run: |
          ./build.sh --canary ${{ needs.prepare.outputs.canary_version }} --verbose
          
      - name: –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
        uses: actions/upload-artifact@v4
        with:
          name: canary-build-artifacts
          path: |
            backend-*/build/libs/*.jar
            frontend/build
            
  test:
    name: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–Ω–∞—Ä–µ–µ—á–Ω–æ–π –≤–µ—Ä—Å–∏–∏
    needs: [prepare, build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout –∫–æ–¥–∞
        uses: actions/checkout@v4
        
      - name: –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —Å–±–æ—Ä–∫–∏
        uses: actions/download-artifact@v4
        with:
          name: canary-build-artifacts
          
      - name: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ä–µ–¥—ã
        run: |
          mkdir -p test-reports
          
      - name: –ó–∞–ø—É—Å–∫ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
        run: |
          ./gradlew functionalTest -Pcanary=true -Pversion=${{ needs.prepare.outputs.canary_version }}-canary
          
      - name: –ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
        run: |
          ./gradlew integrationTest -Pcanary=true -Pversion=${{ needs.prepare.outputs.canary_version }}-canary
          
      - name: –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–æ–≤ –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: test-reports
          
  security_scan:
    name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    needs: [prepare, build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout –∫–æ–¥–∞
        uses: actions/checkout@v4
        
      - name: –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —Å–±–æ—Ä–∫–∏
        uses: actions/download-artifact@v4
        with:
          name: canary-build-artifacts
          
      - name: –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        uses: anchore/scan-action@v3
        with:
          path: "."
          fail-build: false
          
      - name: OWASP —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
        run: |
          ./gradlew dependencyCheckAnalyze
          
      - name: –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–∞ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: build/reports/dependency-check-report.html
          
  build_images:
    name: –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤
    needs: [prepare, test, security_scan]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout –∫–æ–¥–∞
        uses: actions/checkout@v4
        
      - name: –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —Å–±–æ—Ä–∫–∏
        uses: actions/download-artifact@v4
        with:
          name: canary-build-artifacts
          
      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker Buildx
        uses: docker/setup-buildx-action@v2
        
      - name: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Docker Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}
          
      - name: –°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è API Gateway –æ–±—Ä–∞–∑–∞
        uses: docker/build-push-action@v4
        with:
          context: ./api-gateway
          push: true
          tags: ${{ env.REGISTRY }}/aquastream/api-gateway:${{ needs.prepare.outputs.canary_version }}-canary
          
      - name: –°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è User Service –æ–±—Ä–∞–∑–∞
        uses: docker/build-push-action@v4
        with:
          context: ./backend-user
          push: true
          tags: ${{ env.REGISTRY }}/aquastream/user-service:${{ needs.prepare.outputs.canary_version }}-canary
          
      - name: –°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤
        run: |
          # –°–±–æ—Ä–∫–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
          for service in backend-catalog backend-order; do
            docker build -t ${{ env.REGISTRY }}/aquastream/$service:${{ needs.prepare.outputs.canary_version }}-canary ./$service
            docker push ${{ env.REGISTRY }}/aquastream/$service:${{ needs.prepare.outputs.canary_version }}-canary
          done
          
  deploy_canary:
    name: –î–µ–ø–ª–æ–π –∫–∞–Ω–∞—Ä–µ–µ—á–Ω–æ–π –≤–µ—Ä—Å–∏–∏
    needs: [prepare, build_images]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout –∫–æ–¥–∞
        uses: actions/checkout@v4
        
      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ kubectl
        uses: azure/k8s-set-context@v3
        with:
          kubeconfig: ${{ secrets.KUBE_CONFIG }}
          
      - name: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Docker Compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        run: |
          mkdir -p deploy
          
          # –≠–∫—Å–ø–æ—Ä—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –∫–∞–Ω–∞—Ä–µ–µ—á–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è
          cat > deploy/.env << EOF
          CANARY_VERSION=${{ needs.prepare.outputs.canary_version }}-canary
          TRAFFIC_PERCENTAGE=${{ env.TRAFFIC_PERCENTAGE }}
          EOF
          
          # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Docker Compose —Ñ–∞–π–ª–æ–≤
          cp infra/docker/compose/docker-compose.canary.yml deploy/
          
      - name: –î–µ–ø–ª–æ–π –∫–∞–Ω–∞—Ä–µ–µ—á–Ω–æ–π –≤–µ—Ä—Å–∏–∏
        run: |
          cd deploy
          
          # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ Kubernetes
          kubectl apply -f k8s/canary/
          
          # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ —Ç—Ä–∞—Ñ–∏–∫–∞
          kubectl set env deployment/traffic-manager CANARY_VERSION=${{ needs.prepare.outputs.canary_version }}-canary
          kubectl set env deployment/traffic-manager CANARY_TRAFFIC_PERCENT=${{ env.TRAFFIC_PERCENTAGE }}
          
          echo "–ö–∞–Ω–∞—Ä–µ–µ—á–Ω–∞—è –≤–µ—Ä—Å–∏—è —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞. –ü—Ä–æ—Ü–µ–Ω—Ç —Ç—Ä–∞—Ñ–∏–∫–∞: ${{ env.TRAFFIC_PERCENTAGE }}%"
          
      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
        run: |
          # –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
          kubectl rollout status deployment/api-gateway-canary
          kubectl rollout status deployment/user-service-canary
          
          # –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–¥–∞—Ö
          kubectl get pods -l app=aquastream,version=canary
          
  configure_alerts:
    name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–ø–æ–≤–µ—â–µ–Ω–∏–π
    needs: [deploy_canary]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.enable_alerts != 'false' }}
    steps:
      - name: Checkout –∫–æ–¥–∞
        uses: actions/checkout@v4
        
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc curl

      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–ø–æ–≤–µ—â–µ–Ω–∏–π
        run: |
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
          mkdir -p infra/docker/config/canary/alerts
          
          # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä–æ–≥–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
          ./infra/docker/scripts/canary-alerts.sh --metrics 25 --errors-threshold 8 --latency-threshold 600 --interval 5
          
          # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Slack –æ–ø–æ–≤–µ—â–µ–Ω–∏–π, –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω
          if [[ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]]; then
            ./infra/docker/scripts/canary-alerts.sh --slack "${{ secrets.SLACK_WEBHOOK_URL }}"
            echo "–ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –æ–ø–æ–≤–µ—â–µ–Ω–∏—è –≤ Slack"
          fi
          
          # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Email –æ–ø–æ–≤–µ—â–µ–Ω–∏–π, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã –ø–æ–ª—É—á–∞—Ç–µ–ª–∏
          if [[ -n "${{ secrets.ALERT_EMAIL_RECIPIENTS }}" ]]; then
            ./infra/docker/scripts/canary-alerts.sh --email "${{ secrets.ALERT_EMAIL_RECIPIENTS }}"
            echo "–ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –æ–ø–æ–≤–µ—â–µ–Ω–∏—è –ø–æ Email"
          fi
          
          echo "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –æ–ø–æ–≤–µ—â–µ–Ω–∏–π –¥–ª—è –∫–∞–Ω–∞—Ä–µ–µ—á–Ω–æ–π –≤–µ—Ä—Å–∏–∏ ${{ needs.prepare.outputs.canary_version }}"
          cat infra/docker/config/canary/alerts/alerts_config.json
          
      - name: –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è
        run: |
          ./infra/docker/scripts/canary-alerts.sh --test
          
      - name: –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã –æ–ø–æ–≤–µ—â–µ–Ω–∏–π –≤ Kubernetes
        run: |
          # –°–æ–∑–¥–∞–µ–º ConfigMap –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –æ–ø–æ–≤–µ—â–µ–Ω–∏–π
          kubectl create configmap canary-alerts-config --from-file=infra/docker/config/canary/alerts/alerts_config.json -o yaml --dry-run=client | kubectl apply -f -
          
          # –ü—Ä–∏–º–µ–Ω—è–µ–º –¥–µ–ø–ª–æ–π–º–µ–Ω—Ç –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –æ–ø–æ–≤–µ—â–µ–Ω–∏–π
          cat << EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: canary-alerts
            labels:
              app: aquastream
              component: canary-alerts
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: aquastream
                component: canary-alerts
            template:
              metadata:
                labels:
                  app: aquastream
                  component: canary-alerts
              spec:
                containers:
                - name: canary-alerts
                  image: ${{ env.REGISTRY }}/aquastream/base-image:latest
                  command: ["/bin/bash", "-c"]
                  args:
                  - |
                    mkdir -p /app/infra/docker/config/canary/alerts
                    cp /config/alerts_config.json /app/infra/docker/config/canary/alerts/
                    cd /app
                    ./infra/docker/scripts/canary-alerts.sh --verbose
                  volumeMounts:
                  - name: alerts-config
                    mountPath: /config
                volumes:
                - name: alerts-config
                  configMap:
                    name: canary-alerts-config
          EOF
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—É—Å–∫ –ø–æ–¥–∞ —Å —Å–∏—Å—Ç–µ–º–æ–π –æ–ø–æ–≤–µ—â–µ–Ω–∏–π
          kubectl rollout status deployment/canary-alerts
          
      - name: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ–ø–æ–≤–µ—â–µ–Ω–∏—è—Ö
        run: |
          echo "–°–∏—Å—Ç–µ–º–∞ –æ–ø–æ–≤–µ—â–µ–Ω–∏–π –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏ –∑–∞–ø—É—â–µ–Ω–∞ –¥–ª—è –∫–∞–Ω–∞—Ä–µ–µ—á–Ω–æ–π –≤–µ—Ä—Å–∏–∏ ${{ needs.prepare.outputs.canary_version }}"
          echo "–ü–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ - 25%, –æ—à–∏–±–∫–∏ - 8, –∑–∞–¥–µ—Ä–∂–∫–∞ - 600 –º—Å"
          echo "–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏: 5 –º–∏–Ω—É—Ç"
          
  perform_ab_test:
    name: A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    needs: [prepare, deploy_canary, configure_alerts]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout –∫–æ–¥–∞
        uses: actions/checkout@v4
        
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: |
          sudo apt-get update
          sudo apt-get install -y apache2-utils bc
          
      - name: –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤
        run: |
          mkdir -p test-reports/ab-test
          
      - name: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        run: |
          # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–ø–∏—Å–æ–∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –∏–∑ —Å—Ç—Ä–æ–∫–∏ –≤ –º–∞—Å—Å–∏–≤
          IFS=',' read -ra ENDPOINTS <<< "${{ env.TEST_ENDPOINTS }}"
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å –æ–ø—Ü–∏—è–º–∏ –¥–ª—è ab-test.sh
          ENDPOINT_OPTS=""
          for endpoint in "${ENDPOINTS[@]}"; do
            ENDPOINT_OPTS="$ENDPOINT_OPTS -e $endpoint"
          done
          
          echo "ENDPOINT_OPTS=$ENDPOINT_OPTS" >> $GITHUB_ENV
          
      - name: –ó–∞–ø—É—Å–∫ A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        run: |
          ./infra/docker/scripts/ab-test.sh -n 1000 -c 20 ${{ env.ENDPOINT_OPTS }} \
            -s api.example.com:80 \
            -k canary-api.example.com:80 \
            -o test-reports/ab-test \
            --html --json --csv
            
      - name: –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–æ–≤ A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        uses: actions/upload-artifact@v4
        with:
          name: ab-test-reports
          path: test-reports/ab-test
          
      - name: –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        id: ab_test_analysis
        run: |
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–∑ JSON-–æ—Ç—á—ë—Ç–æ–≤
          results_json=$(find test-reports/ab-test -name "*.json" -type f)
          
          # –§–ª–∞–≥ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –æ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–∏
          promote_flag=true
          
          for result in $results_json; do
            recommendation=$(jq -r '.comparison.recommendation' $result)
            endpoint=$(jq -r '.test_info.endpoint' $result)
            
            echo "–≠–Ω–¥–ø–æ–∏–Ω—Ç $endpoint: —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è - $recommendation"
            
            if [ "$recommendation" == "rollback" ]; then
              promote_flag=false
              echo "::warning::–ü—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–µ $endpoint"
            fi
          done
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ—à–µ–Ω–∏–µ –∫–∞–∫ output
          echo "promote_recommended=$promote_flag" >> $GITHUB_OUTPUT
          
          if [ "$promote_flag" == "true" ]; then
            echo "‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –∫–∞–Ω–∞—Ä–µ–µ—á–Ω–æ–π –≤–µ—Ä—Å–∏–∏."
          else
            echo "‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã –≤ –∫–∞–Ω–∞—Ä–µ–µ—á–Ω–æ–π –≤–µ—Ä—Å–∏–∏. –ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ."
          fi
          
  promote_decision:
    name: –†–µ—à–µ–Ω–∏–µ –æ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–∏
    needs: [prepare, perform_ab_test]
    runs-on: ubuntu-latest
    steps:
      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        run: |
          if [ "${{ needs.perform_ab_test.outputs.promote_recommended }}" == "true" ]; then
            echo "‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –∫–∞–Ω–∞—Ä–µ–µ—á–Ω–æ–π –≤–µ—Ä—Å–∏–∏ ${{ needs.prepare.outputs.canary_version }}"
            echo "–ü–æ—Å–µ—Ç–∏—Ç–µ Grafana –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–µ—Ç—Ä–∏–∫: https://grafana.example.com/d/canary/canary-deployment"
          else
            echo "‚ö†Ô∏è –ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ ${{ needs.prepare.outputs.canary_version }}"
            echo "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
          fi
          
      - name: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ
        if: needs.perform_ab_test.outputs.promote_recommended == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üöÄ –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –∫–∞–Ω–∞—Ä–µ–µ—á–Ω–æ–π –≤–µ—Ä—Å–∏–∏ ${{ needs.prepare.outputs.canary_version }}',
              body: `
              # –ó–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –∫–∞–Ω–∞—Ä–µ–µ—á–Ω–æ–π –≤–µ—Ä—Å–∏–∏
              
              ## –í–µ—Ä—Å–∏—è
              - **–ö–∞–Ω–∞—Ä–µ–µ—á–Ω–∞—è –≤–µ—Ä—Å–∏—è:** ${{ needs.prepare.outputs.canary_version }}
              
              ## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
              - ‚úÖ A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–π–¥–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
              - üìä –¢–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç —Ç—Ä–∞—Ñ–∏–∫–∞: ${{ env.TRAFFIC_PERCENTAGE }}%
              
              ## –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
              1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –≤ [Grafana](https://grafana.example.com/d/canary/canary-deployment)
              2. –ï—Å–ª–∏ –≤—Å—ë –≤ –ø–æ—Ä—è–¥–∫–µ, –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ä—É—á–Ω–æ–π workflow –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è:
                 \`\`\`
                 ./infra/docker/scripts/canary.sh -x
                 \`\`\`
              
              ## –°–≤—è–∑–∞–Ω–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
              - [–û—Ç—á–µ—Ç—ã A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è](${process.env.GITHUB_SERVER_URL}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              
              /cc @DevOps @QA
              `
            })
            
      - name: –°–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö
        if: needs.perform_ab_test.outputs.promote_recommended != 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã —Å –∫–∞–Ω–∞—Ä–µ–µ—á–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π ${{ needs.prepare.outputs.canary_version }}',
              body: `
              # –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–∞–Ω–∞—Ä–µ–µ—á–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π
              
              ## –í–µ—Ä—Å–∏—è
              - **–ö–∞–Ω–∞—Ä–µ–µ—á–Ω–∞—è –≤–µ—Ä—Å–∏—è:** ${{ needs.prepare.outputs.canary_version }}
              
              ## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
              - ‚ùå A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã—è–≤–∏–ª–æ –ø—Ä–æ–±–ª–µ–º—ã
              - üìä –¢–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç —Ç—Ä–∞—Ñ–∏–∫–∞: ${{ env.TRAFFIC_PERCENTAGE }}%
              
              ## –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
              1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –≤ [Grafana](https://grafana.example.com/d/canary/canary-deployment)
              2. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ª–æ–≥–∏ –∫–∞–Ω–∞—Ä–µ–µ—á–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
              3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö
              4. –†–µ—à–∏—Ç–µ, –Ω—É–∂–Ω–æ –ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–Ω–∞—Ä–µ–µ—á–Ω—ã–π –¥–µ–ø–ª–æ–π:
                 \`\`\`
                 ./infra/docker/scripts/canary.sh -p
                 \`\`\`
              
              ## –°–≤—è–∑–∞–Ω–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
              - [–û—Ç—á–µ—Ç—ã A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è](${process.env.GITHUB_SERVER_URL}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              
              /cc @DevOps @Development
              `
            }) 