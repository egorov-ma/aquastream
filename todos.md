# AquaStream Backend-Infra — TODOs (приоритезированный бэклог)

Цель: довести модуль `backend-infra/` до «идеального» уровня по dev/prod практикам, безопасности, удобству, наблюдаемости и CI/CD. Выполнять задачи по порядку. Для каждой задачи описаны цель, контекст, ожидаемый результат, шаги, критерии приемки, зависимости и оценка.

— Важно: папка `backend-infra/docs/` — устаревший остаток; её надо удалить (см. Задача 2).


## 1) Канонизация путей и нейминга модуля `backend-infra`
- Приоритет: P0
- Цель: единый нейминг и корректные пути в скриптах/Makefile/документации.
- Контекст: встречается смешение `infra/` и `backend-infra/`; из‑за этого пути ломаются (бэкап‑скрипты, Liquibase‑команды, ссылки в доках, pre‑commit hook).
- Ожидаемый результат:
  - Все скрипты и Make‑таргеты используют пути в рамках `backend-infra/`.
  - Документация и ссылки в `docs/` не указывают на несуществующую `infra/`.
- Шаги:
  1. В `backend-infra/backup/backup.sh` заменить `ARTIFACTS_DIR` на `"$ROOT_DIR/backend-infra/backup/artifacts"`.
  2. В `backend-infra/make/Makefile` у Liquibase‑таргетов заменить монтирование с `$(ROOT_DIR)/backend-user/...` на `$(REPO_ROOT)/backend-user/...`.
  3. Просканировать `docs/**` и заменить ссылки `infra/...` → `backend-infra/...` (проверить `modules/backend-infra/*`).
  4. Обновить `.githooks/infra-pre-commit-hook`: актуализировать список проверяемых файлов (один `docker/compose/docker-compose.yml`, без `docker-compose.dev.yml|full.yml`).
- Критерии приемки:
  - `make backup`, `make restore`, `make liq-user-sql`, `make liq-user-update` работают из корня, без ошибок путей.
  - Линтеры/генераторы документации не находят битых ссылок на `infra/...`.
  - Pre‑commit hook корректно отрабатывает при изменениях Compose/Dockerfile.
- Зависимости: нет
- Оценка: S (2–4 часа)


## 2) Удаление устаревшей папки `backend-infra/docs/`
- Приоритет: P0
- Цель: убрать дублирующий, устаревший контент; оставить единый портал документации в `docs/`.
- Контекст: пользователь отметил, что `backend-infra/docs` — остаток до миграции в `/docs`.
- Ожидаемый результат:
  - Папка `backend-infra/docs/` удалена.
  - Никакие активные ссылки и процессы на неё не ссылаются.
- Шаги:
  1. Поиск ссылок на `backend-infra/docs` в репозитории; скорректировать/удалить.
  2. Удалить каталог `backend-infra/docs/`.
  3. Прогнать проверки линков в доках (`make -C docs/docs-tools lychee` если используется).
- Критерии приемки:
  - Поиск по репозиторию не находит `backend-infra/docs/`.
  - Проверка линков без ошибок.
- Зависимости: Задача 1 (ссылки)
- Оценка: XS (0.5–1 час)


## 3) Шаблоны окружения и перевод Compose на `env_file`
- Приоритет: P0
- Цель: убрать секреты/пароли из Compose, стандартизировать переменные для dev/stage/prod.
- Контекст: сейчас пароли и дефолты заданы прямо в Compose; один и тот же профильный набор на все среды.
- Ожидаемый результат:
  - В `backend-infra/docker/compose/` добавить: `.env.example`, `.env.dev.example`, `.env.stage.example`, `.env.prod.example` с комментариями.
  - `docker-compose.yml` использует `env_file` (по профилям/оверлеям).
  - Секреты и чувствительные значения не закоммичены.
- Шаги:
  1. Сформировать `.env.*.example` (Postgres/Redis/MinIO/JWT/Telegram/YooKassa/S3/CORS/Profiles). Добавить в `.gitignore` реальное `.env*`.
  2. Перевести переменные Compose из `environment:` на `env_file:`.
  3. В доках описать где какие `.env` применять и как переключать среды.
- Критерии приемки:
  - `make up-dev` работает при наличии `.env.dev`.
  - В Compose нет захардкоженных секретов.
- Зависимости: Задача 1
- Оценка: S (2–4 часа)


## 4) Реструктуризация Compose: base + overlays (dev/stage)
- Приоритет: P0
- Цель: безопасные настройки по средам, меньшая экспозиция сервисов.
- Контекст: текущий `docker-compose.yml` публикует БД/Redis для всех профилей; нужен разделённый слой.
- Ожидаемый результат:
  - Базовый `docker-compose.yml` (общая сеть, volumes, сервисы без публикации портов и без дефолтных секретов).
  - `docker-compose.override.dev.yml`: публикация портов, удобства девелопмента.
  - `docker-compose.override.stage.yml`: ограничения, без лишних портов.
  - Добавлены `restart: unless-stopped`, `logging` (ротация), ресурсные лимиты, `healthcheck` у приложений.
- Шаги:
  1. Вынести публикацию портов (Postgres/Redis/MinIO/Apps) в `override.dev.yml`.
  2. Добавить `restart`, `logging` (например, `max-size: 10m`, `max-file: 5`), умеренные лимиты памяти/CPU.
  3. Добавить `healthcheck` для всех приложений (`/actuator/health`).
  4. Зафиксировать версии образов (не `:latest`).
- Критерии приемки:
  - Dev: `make up-dev` поднимает всё с портами, `make smoke` зелёный.
  - Stage: `make up-stage` — внешних портов у БД/Redis нет.
- Зависимости: 1, 3
- Оценка: M (1 день)


## 5) Dockerfiles для всех сервисов + запуск от non‑root
- Приоритет: P0
- Цель: единый, безопасный шаблон Dockerfile для всех `backend-*` сервисов.
- Контекст: сейчас есть только `gateway` и `notification`; у `gateway` нет HEALTHCHECK и non‑root пользователя.
- Ожидаемый результат:
  - Dockerfiles для: user, event, crew, payment, media — по единому паттерну.
  - Везде: запуск под `USER app`, HEALTHCHECK, `JAVA_TOOL_OPTIONS`, минимальная JRE (temurin/или distroless), предсказуемый `ARG JAR_FILE`.
  - Убрать правило `Dockerfile*` из `.dockerignore` (чтобы Dockerfile попал в контекст).
- Шаги:
  1. Создать Dockerfile по образцу `notification` с доработками: добавить `useradd`, `USER app`, HEALTHCHECK, ровный EXPOSE.
  2. Добавить недостающие Dockerfile.<service> и указать правильные `ARG JAR_FILE`.
  3. Обновить `.dockerignore` — не игнорировать Dockerfile.
- Критерии приемки:
  - `docker build` для каждого сервиса успешен; контейнер запускается; `HEALTHCHECK` становится healthy.
- Зависимости: 1
- Оценка: M (1 день)


## 6) MinIO bootstrap (автосоздание бакетов/политик)
- Приоритет: P1
- Цель: убрать ручные шаги по первичной настройке MinIO.
- Контекст: сейчас бакеты/политики не создаются автоматически.
- Ожидаемый результат:
  - Скрипт/инициатор (через `minio/mc`) создаёт нужные бакеты и политики при `up-dev`.
- Шаги:
  1. Добавить однократный init‑контейнер или скрипт в compose (`command: sh -c "until minio alive; mc alias set ...; mc mb ..."`).
  2. Список бакетов согласовать с `backend-media`/`backend-payment`.
- Критерии приемки:
  - После `make up-dev` бакеты существуют; загрузка/чтение работает без ручных действий.
- Зависимости: 4
- Оценка: S (2–4 часа)


## 7) CI/CD на образы (GHCR) + buildx cache
- Приоритет: P1
- Цель: автоматическая сборка и публикация образов на каждый push/PR и по тегам.
- Контекст: сейчас есть только Gradle CI (JAR); контейнеры не собираются.
- Ожидаемый результат:
  - Workflow `ci-images.yml` (матрица по сервисам): buildx, кэш, теги `:sha-<short>`, по релиз‑тегам `:vX.Y.Z` и `:latest`.
  - Push в GHCR с использованием `GITHUB_TOKEN`.
- Шаги:
  1. Добавить `.github/workflows/ci-images.yml` (матрица `backend-*`).
  2. Настроить build‑args `JAR_FILE` и порядок (Gradle build → docker build/push).
  3. Публиковать теги и выставлять Summary.
- Критерии приемки:
  - По PR выполняется build (без push) и скан; по merge — push в GHCR.
- Зависимости: 5
- Оценка: M (1 день)


## 7.1) Улучшения и тест‑план для CI/CD (после внедрения 7)
- Приоритет: P1
- Цель: усилить эффективность и надёжность CI/CD; формально протестировать все существующие GitHub Actions.
- Контекст: Workflow `ci-images.yml` внедрён (Задача 7). Есть идеи оптимизаций и необходим регламентированный тест‑план на все workflows.
- Ожидаемый результат:
  - Определён и выполнен тест‑план для всех workflows; результаты задокументированы (успешные/ошибки/лог‑ссылки).
  - Приняты решения по улучшениям и создан трекер задач (при необходимости — внесены правки).
- Улучшения (идеи):
  1. `ci-images.yml`: собирать JAR один раз в отдельном job и раздавать артефактом в матричные сборки (уменьшит время x7).
  2. `ci-images.yml`: при необходимости явно фиксировать платформу `linux/amd64` (быстрее), а multi-arch вынести в отдельную задачу.
  3. `docs-ci.yml`: ключ кэша pip считать от пути `docs/docs-tools/requirements-docs.txt` (сейчас хеш считается от корневого имени).
  4. Единообразный `concurrency` во всех workflow (проверить/добавить там, где отсутствует).
  5. Проверить корректность триггеров `paths`/веток во всех workflow, чтобы исключить лишние прогонки.
  6. (На будущее, связано с Задачей 8) Выделить security‑сканы и SBOM в отдельные шаги/джобы с правилами fail для main.
- Перечень workflows к тестированию:
  - `backend-ci.yml` — сборка Gradle (Java), загрузка JAR как артефактов.
  - `ci-images.yml` — сборка Docker образов для сервисов, Trivy scan на PR, push в GHCR на `main` и по тегам `v*`.
  - `frontend-ci.yml` — pnpm install/lint/typecheck/build.
  - `docs-ci.yml` — строгая сборка MkDocs.
  - `docs-deploy.yml` — публикация сайта на GitHub Pages.
  - `release.yml` — создание GitHub Release по тегам `v*` и вручную.
  - `codeql.yml` — CodeQL анализ (Java/JS/Python).
  - `commitlint.yml` — проверка коммитов и заголовка PR.
  - `labeler.yml` — автоприсвоение меток на PR.
  - `label-sync.yml` — синхронизация набора меток из файла.
- Предусловия:
  - Включены GitHub Pages (Source: GitHub Actions), доступы `pages: write` есть у `docs-deploy.yml`.
  - GHCR доступен для репозитория; `GITHUB_TOKEN` имеет `packages: write` (public/private в зависимости от настроек).
  - Для тестов с тегами: разрешено пушить теги в репозиторий (роль Maintainer).
- Шаги (тест‑план):
  1. `backend-ci.yml`:
     - Действие: открыть PR с изменениями в `backend-*/**`.
     - Ожидание: workflow срабатывает на PR и проходит `./gradlew build`; артефакты `**/build/libs/*.jar` загружены.
  2. `ci-images.yml` (PR):
     - Действие: тот же PR (или отдельный) с изменениями в `backend-*`/`backend-infra/docker/**`.
     - Ожидание: запустятся 7 job по матрице; образы собраны (без push); пройдёт Trivy scan; в Summary видны `sha-<short>`.
  3. `ci-images.yml` (push main):
     - Действие: смержить PR в `main`.
     - Ожидание: сборка и push в GHCR с тегом `sha-<short>` для каждого сервиса; образы доступны в GHCR.
  4. `ci-images.yml` (тег `vX.Y.Z`):
     - Действие: создать тег `vX.Y.Z` и пушнуть в origin.
     - Ожидание: у каждого образа опубликованы теги `vX.Y.Z`, `latest` и `sha-<short>`.
  5. `frontend-ci.yml`:
     - Действие: открыть PR с изменениями во `frontend/**`.
     - Ожидание: lint/typecheck/build успешны.
  6. `docs-ci.yml`:
     - Действие: PR с изменениями в `docs/**`.
     - Ожидание: строгая сборка MkDocs без ошибок.
  7. `docs-deploy.yml`:
     - Действие: пуш изменений в `docs/**` в `main`.
     - Ожидание: Pages задеплоены; ссылка `environment: github-pages` активна.
  8. `release.yml`:
     - Действие: пуш тега `vA.B.C` или ручной запуск с input `tag`.
     - Ожидание: создан GitHub Release с автогенерацией Release Notes.
  9. `codeql.yml`:
     - Действие: PR в `main` или дождаться расписания.
     - Ожидание: завершение анализа без ошибок workflow; артефакты/алерты видны в Security.
  10. `commitlint.yml`:
      - Действие: открыть PR с корректным заголовком; сделать коммиты согласно Conventional Commits.
      - Ожидание: проверки проходят; при некорректном заголовке — job красный с сообщением commitlint.
  11. `labeler.yml`:
      - Действие: открыть PR с изменениями подпадающими под правила `.github/labeler.yml`.
      - Ожидание: нужные лейблы автоматически добавлены/синхронизированы.
  12. `label-sync.yml`:
      - Действие: изменить `.github/labels.yml` и запушить в `main` (или запустить вручную).
      - Ожидание: набор лейблов репозитория синхронизирован по файлу.
- Критерии приемки:
  - Все перечисленные workflow успешно проходят по сценарию; для `ci-images.yml` подтверждён push в GHCR и наличие нужных тегов.
  - По итогам тест‑прогона зафиксированы улучшения (минимум по пунктам 1–3) и/или созданы отдельные подзадачи.
- Зависимости: 7
- Оценка: M (1 день)


## 8) Security Scan + SBOM (Trivy/Grype + Syft)
- Приоритет: P1
- Цель: контроль уязвимостей и формирование SBOM на каждый образ.
- Контекст: сейчас нет security‑сканов в CI/CD.
- Ожидаемый результат:
  - Шаги Trivy/Grype в CI (фейлят по High/Critical), загрузка отчётов как артефактов.
  - Генерация SBOM (Syft) и прикрепление к релизам.
- Шаги:
  1. В `ci-images.yml` добавить шаги scan после сборки; на PR — без fail, на main — fail по High/Critical.
  2. Добавить Syft для SBOM (`spdx-json`).
- Критерии приемки:
  - Отчёты доступны в Actions; при критических уязвимостях job падает (для main).
- Зависимости: 7
- Оценка: S (2–4 часа)


## 9) Pre-commit hook для infra: обновить и расширить проверки
- Приоритет: P1
- Цель: предотвратить ошибки до коммита.
- Контекст: текущий хук проверяет неактуальные файлы и частично‑полезные правила.
- Ожидаемый результат:
  - Обновлённый `.githooks/infra-pre-commit-hook` проверяет: запрет `:latest`, отсутствие секретов в compose, bash‑lint, YAML‑валидность (yq), hadolint для Dockerfiles (если установлен).
- Шаги:
  1. Переписать список файлов; добавить hadolint (опционально), улучшить проверку секретов.
  2. Обновить README с инструкцией установки hook.
- Критерии приемки:
  - При ошибках (`:latest`, секреты в compose, синтаксические ошибки) — коммит блокируется.
- Зависимости: 1, 4, 5
- Оценка: S (2–4 часа)


## 10) Observability (dev overlay): Prometheus + Grafana + Loki/Promtail
- Приоритет: P2
- Цель: быстрый старт наблюдаемости локально.
- Контекст: сейчас нет метрик/логов/трейсов в dev окружении.
- Ожидаемый результат:
  - `docker-compose.override.dev.yml` включает Prometheus, Grafana, Loki, Promtail (или OTel‑collector) и базовые конфиги.
- Шаги:
  1. Добавить сервисы и `prometheus.yml` с scrape targets actuator `/actuator/prometheus`.
  2. Настроить Promtail на сбор логов контейнеров.
  3. Подготовить базовую Grafana dashboard provisioning.
- Критерии приемки:
  - Метрики видны в Prometheus, логи в Loki, дешборды доступны в Grafana.
- Зависимости: 4
- Оценка: M (1–2 дня)


## 11) Бэкапы: сжатие, шифрование и политика хранения
- Приоритет: P2
- Цель: надёжные бэкапы без мусора в репозитории.
- Контекст: дампы лежат в репозитории, нет сжатия/шифрования.
- Ожидаемый результат:
  - `backup.sh` создаёт `.dump.gz` (gzip), опционально шифрует (age/sops), артефакты исключены из Git.
  - Make‑таргет для загрузки на удалённое хранилище (опционально).
- Шаги:
  1. Добавить gzip; обновить retention под новые маски; исключить `backup/artifacts` из Git.
  2. Опционально: age/sops шифрование и простой upload (s3/rclone).
- Критерии приемки:
  - `make backup` создаёт сжатые файлы; `make restore` умеет читать из `.dump.gz`.
- Зависимости: 1, 3
- Оценка: S (2–4 часа)


## 12) Чистка легаси: `docker-compose.services.yml` и пр.
- Приоритет: P2
- Цель: убрать неиспользуемые или устаревшие файлы.
- Контекст: `backend-infra/docker/docker-compose.services.yml` использует несуществующие пути `infra/...`.
- Ожидаемый результат:
  - Файл удалён или приведён в соответствие текущей структуре.
- Шаги:
  1. Решить: нужен ли файл (если отдельная демонстрация build — обновить пути). Иначе — удалить.
  2. Проверить, что CI/доки не ссылаются на него.
- Критерии приемки:
  - Поиск по репозиторию не находит битых ссылок на файл.
- Зависимости: 1
- Оценка: XS (0.5–1 час)


## 13) Обновление документации по infra
- Приоритет: P2
- Цель: документация отражает новую структуру и практики.
- Контекст: в ряде мест встречается `infra/...`, детали профилей/переменных устарели.
- Ожидаемый результат:
  - Обновлены разделы в `docs/modules/backend-infra/DEVELOPER.md` и др.: env‑файлы, overlays, Observability, CI/CD.
  - Добавлен `backend-infra/README.md` (краткий гид по запуску infra).
- Шаги:
  1. Правки ссылок и примеров команд.
  2. Краткий README внутри `backend-infra/`.
- Критерии приемки:
  - Документация соответствует итоговой конфигурации; линк‑чекеры зелёные.
- Зависимости: 1, 3, 4, 7–10
- Оценка: S (2–4 часа)


## 14) Политики безопасности Compose
- Приоритет: P2
- Цель: усилить изоляцию контейнеров.
- Контекст: сейчас нет `read_only`, `cap_drop`, `user`, ограничений ulimits.
- Ожидаемый результат:
  - Для приложений: `user: 1000:1000`, `read_only: true` (где применимо), `tmpfs` для `/tmp`, `cap_drop: [ALL]` с нужными исключениями, ulimits для nofile.
- Шаги:
  1. Протестировать применение политик на dev; адаптировать если сервисам нужен запись.
- Критерии приемки:
  - Приложения стартуют и работают; политики применены.
- Зависимости: 4, 5
- Оценка: S (2–4 часа)


## 15) Pinning версий базовых образов и зависимостей
- Приоритет: P2
- Цель: воспроизводимость сборок.
- Контекст: есть `minio/minio:latest` и др.
- Ожидаемый результат:
  - Конкретные теги образов в Compose и Dockerfiles; Dependabot обновляет `/backend-infra/docker/images`.
- Шаги:
  1. Выбрать и зафиксировать минимальные устойчивые теги.
  2. Проверить `.github/dependabot.yml` (путь уже настроен под `/backend-infra/docker/images`).
- Критерии приемки:
  - Нет `:latest` в infra.
- Зависимости: 4, 5
- Оценка: XS (0.5–1 час)


## 16) K8s/Helm (скелет для будущего прод‑деплоя)
- Приоритет: P3 (следующая фаза)
- Цель: подготовить путь к production: чарты/манифесты, values per env.
- Контекст: сейчас только Compose.
- Ожидаемый результат:
  - `backend-infra/helm/` с чартами для каждого сервиса и общими зависимостями (Postgres/Redis/MinIO как зависимость/managed‑сервисы).
- Шаги:
  1. Сгенерировать чарты, добавить liveness/readiness, ресурсы, секреты, HPA.
  2. Значения `values.dev|stage|prod.yaml`.
- Критерии приемки:
  - `helm template` валиден; мини‑кластер (kind) поднимает все сервисы.
- Зависимости: 5, 10, 14, 15
- Оценка: L (3–5 дней)


## 17) Terraform/Pulumi baseline (VPC/DB/S3/Registry/Secrets)
- Приоритет: P3 (следующая фаза)
- Цель: управляемая инфраструктура как код.
- Контекст: нет IaC.
- Ожидаемый результат:
  - `backend-infra/terraform/` с модулями под сеть, БД (или managed), S3, секреты, GHCR доступ, state backend.
- Шаги:
  1. Определить целевую облачную платформу; подготовить минимальные модули.
  2. Настроить remote state и простой план для dev окружения.
- Критерии приемки:
  - `terraform plan/apply` поднимает базовую инфраструктуру.
- Зависимости: 16
- Оценка: L (3–7 дней)


## 18) GitOps (ArgoCD/Flux) для CD в k8s
- Приоритет: P3 (следующая фаза)
- Цель: декларативный деплой по git‑событиям.
- Контекст: после появления Helm.
- Ожидаемый результат:
  - Репозиторий манифестов, ArgoCD/Flux конфигурация, авто‑деплой тэгов образов.
- Шаги:
  1. Подготовить GitOps‑репозиторий; связать с кластерами.
  2. Настроить автоматизацию обновления образов (image updater/Helm values).
- Критерии приемки:
  - Коммит в GitOps ведёт к раскату новой версии в k8s.
- Зависимости: 16, 17
- Оценка: M–L (2–5 дней)


## 19) Управление секретами (SOPS/SealedSecrets)
- Приоритет: P3 (следующая фаза)
- Цель: безопасное хранение и доставка секретов.
- Контекст: подготовка к k8s/prod.
- Ожидаемый результат:
  - Выбран и реализован механизм (SOPS+age или SealedSecrets); описаны процессы ротации.
- Шаги:
  1. Выбрать инструмент; внедрить генерацию и шифрование.
  2. Интегрировать в Helm/K8s и CI.
- Критерии приемки:
  - Секреты не хранятся в plaintext; деплой воспроизводим.
- Зависимости: 16, 18
- Оценка: M (1–2 дня)


## 20) Улучшения Makefile и DX
- Приоритет: P2
- Цель: удобные цели для частых задач.
- Контекст: есть базовые `up/down/logs/backup/restore`.
- Ожидаемый результат:
  - Команды: `make build-images`, `make push-images`, `make scan`, `make sbom`, `make up-dev-observability`, `make minio-bootstrap`.
- Шаги:
  1. Добавить цели и связать с compose/скриптами.
- Критерии приемки:
  - Команды выполняются из корня, покрывая частые сценарии infra.
- Зависимости: 4, 5, 6, 8–10
- Оценка: XS–S (1–3 часа)


---

Порядок выполнения: 1 → 2 → 3 → 4 → 5 → 6 → 7 → 8 → 9 → 10 → 11 → 12 → 13 → 14 → 15 → 20 → 16 → 17 → 18 → 19.

Примечания:
- После задач 1–5 базовый контур станет последовательным и безопаснее; 6–11 закрывают удобство/надёжность; 12–15 — чистка и воспроизводимость; 16–19 — следующая фаза (prod‑grade IaC/CD/секреты).
