# Улучшения фронтенда (без оверинженеринга)

Ниже — консолидированный план улучшений архитектуры, UI/UX и DX. Отсортировано по приоритету (P0 — сначала).

## P0. Единый дизайн‑каркас (Design System на shadcn/ui) — выполнено
- **Цель**: унифицировать визуальный язык и ускорить сборку экранов.
- **Ценность**: меньше разнобоя, проще поддержка, быстрый онбординг.
- **Контекст**: уже используем shadcn/ui + Tailwind; нужно стандартировать каркас.
- **Шаги**:
  1) Примитивы добавлены: `PageHeader` (`components/ui/page-header.tsx`), `Toolbar` (`components/ui/toolbar.tsx`), `Section` (`components/ui/section.tsx`), `EmptyState`/`ErrorState`/`LoadingState` (`components/ui/states.tsx`).
  2) Типографика/отступы/цвета — унификация через Tailwind утилиты; каркас применён на страницах дашборда.
  3) `next/image` используется на страницах с картинками (в т.ч. модерация оплат).
- **Критерии приёмки**:
  - Примитивы присутствуют и используются; новые экраны собираются из них.
  - Состояния Empty/Error/Skeleton реализованы и переиспользуемы.

## P0. Единый стандарт ошибок и запросов — выполнено
- **Цель**: предсказуемая обработка ошибок/загрузок на сервере и клиенте.
- **Ценность**: меньше крашей и «тихих» сбоев; единый UX уведомлений.
- **Контекст**: fetch в разных местах; нужна консолидация и типизация.
- **Шаги**:
  1) Добавлен `serverFetch` (`shared/http.ts`) с абсолютным origin, Abort/timeout и типом `Result<T>`; интегрирован в `shared/data.ts` (ISR + revalidateTags).
  2) Добавлен `clientRequest` (`shared/http.ts`), `HomeCatalog` переведён на него; состояния заменены на `LoadingState/EmptyState/ErrorState`.
  3) Базовая унификация отображения ошибок/пустых состояний выполнена.
- **Критерии приёмки**:
  - SSR/ISR используют `serverFetch`; клиент использует `clientRequest`; унифицированные состояния подключены.

## P0. Платформа форм (RHF + Zod, единые поля) — выполнено
- **Цель**: предсказуемые формы и валидация.
- **Ценность**: меньше багов/дублирования, выше UX сабмита.
- **Контекст**: формы уже есть, но используются неоднородно.
- **Шаги**:
  1) Общая платформа форм: `components/ui/form.tsx` готова и используется.
  2) Переведён `components/login-form.tsx` на `FormField/FormLabel/FormMessage`; Select интегрирован с RHF.
  3) Сообщения ошибок — на русском; сабмит дизейблится во время запроса.
- **Критерии приёмки**:
  - Новые формы используют примитивы, ошибки единообразны.

## P0. Слой данных: консолидация SSR/ISR и мутаций — выполнено
- **Цель**: стабильные загрузки, повторяемость и кеш‑политика.
- **Ценность**: меньше случайных 500/Abort, прозрачный revalidate.
- **Контекст**: уже есть `unstable_cache`/ISR и fetch с абсолютным origin.
- **Шаги**:
  1) Введён `serverFetch` (`shared/http.ts`) и интегрирован в `shared/data.ts` (`getOrganizerCached`, `getOrganizerEventsCached`) с ISR (`revalidate: 60`) и `CACHE_TAGS`.
  2) Добавлены `revalidateTag` в мутациях: `app/api/organizer/events/route.ts` (POST) и `app/api/organizer/events/[id]/route.ts` (PATCH) — инвалидируют списки событий организатора.
  3) Страницы `/org/[orgSlug]` и `/org/[orgSlug]/events` переведены на кеш‑хелперы (`getOrganizerEventsCached`).
  4) Клиентские загрузки используют `clientRequest` (Abort/timeout, Result) и унифицированные состояния.
- **Критерии приёмки**:
  - SSR/ISR используют helper; мутации не ломают кеш (revalidate по тегам); клиент показывает ошибки и пустые состояния единообразно.

## P1. Доступность и гарды (a11y + UX ошибок)
- **Цель**: корректная клавиатурная навигация и понятные ограничения доступа.
- **Ценность**: лучше UX и доступность, меньше «мёртвых» действий.
- **Контекст**: используются Radix‑компоненты; RBAC через middleware.
- **Шаги**:
  1) Пройти a11y‑чек (axe/lighthouse): aria‑атрибуты в Dialog/Sheet/Accordion, фокус‑ловушки, контраст, `focus-visible`.
  2) Улучшить гарды: расширить `middleware.matcher` на подмаршруты (`/dashboard(.*)`, `/org/dashboard(.*)`, `/admin(.*)`).
  3) Добавить страницу 403/ошибки доступа и скрывать недоступные действия в UI.
- **Критерии приёмки**:
  - A11y‑проверки без критичных ошибок; редиректы/сообщения о доступе корректны.

## P1. Безопасность контента и медиа (CSP + next/image)
- **Цель**: безопасный вывод и оптимизация медиа.
- **Ценность**: меньше XSS‑рисков, быстрее загрузка изображений.
- **Контекст**: используется Editor.js; изображения тянутся из внешних источников.
- **Шаги**:
  1) Добавить базовый CSP/Referrer‑Policy/HSTS в `next.config.ts` (headers) для prod.
  2) Настроить `images.remotePatterns`/`domains` в Next для `next/image`.
  3) Ограничить набор блоков в Editor.js и санитизировать вывод (минимально).
- **Критерии приёмки**:
  - Заголовки безопасности отдаются в prod; `next/image` не ломает рендер, изображения оптимизируются.

## P1. Перф и наблюдаемость (минимально, без усложнений)
- **Цель**: удерживать Lighthouse ≥90 и ловить продовые ошибки.
- **Ценность**: прогнозируемое качество, быстрые регрессии.
- **Контекст**: есть `pnpm lh` и базовая Sentry‑интеграция (prod).
- **Шаги**:
  1) В CI добавить smoke Lighthouse (одна метрика/страница) с бюджетами (soft‑fail по флагу).
  2) Sentry modern‑setup: `instrumentation-client.ts`, `Sentry.captureRequestError` в instrumentation, глобальный error boundary.
  3) RSC/клиент: lazy для тяжёлых компонентов, `preload/prefetch` критичных ресурсов; контроль размера First Load JS.
- **Критерии приёмки**:
  - Отчёт Lighthouse ≥90 на ключевых страницах; Sentry принимает ошибки с тегами релиза/окружения.

---

## P2. Таблицы организатора — лёгкая сортировка/фильтры
- **Цель**: улучшить навигацию в списках без тяжёлых библиотек.
- **Ценность**: быстрее находить нужное.
- **Шаги**: добавить client‑сортировку по 1–2 столбцам и фильтр по строке поиска; прогресс вместимости через `Progress`.
- **Критерии**: сорт/фильтр не ломают SSR, сохраняют URL‑параметры при необходимости.

## P2. Предпросмотр изображений и унификация загрузок
- **Цель**: повысить доверие к загрузкам (лого/фото/пруфы).
- **Шаги**: `next/image` превью перед сохранением; единый компонент Upload с ограничениями типа/размера.
- **Критерии**: превью доступен в Brand/Team/QR, единые тексты ошибок/лимитов.

## P2. Waitlist — удобный переключатель
- **Цель**: убрать двойные кнопки join/leave.
- **Шаги**: сделать переключатель состояния + мгновенное обновление счётчика.
- **Критерии**: нажатие меняет состояние без перезагрузки, корректно обрабатывает ошибки.

## P2. SEO/системные страницы
- **Цель**: базовый SEO и дружелюбные ошибки.
- **Шаги**: `metadata` (title/description/og), оформить 404/500 в стиле shadcn.
- **Критерии**: корректные метаданные и кастомные страницы 404/500.

## P2. Санитизация контента Editor.js
- **Цель**: безопасность вывода.
- **Шаги**: ограничить набор блоков/HTML, санитизировать вывод (минимально).
- **Критерии**: запрещённые теги не попадают в DOM.

## P2. Тесты
- **Цель**: закрыть критичные пути и права.
- **Шаги**: e2e сценарий организатора (вход → /org/dashboard), unit для `isAllowed` (табличные кейсы).
- **Критерии**: тесты зелёные; регрессии ролей ловятся.

## P3. DevEx и документация
- **Цель**: ускорить онбординг и локализацию проблем.
- **Шаги**: `.env.example`, таблица RBAC в README, Playwright в CI по флагу, фикстуры MSW (`__reset`), кэш pnpm в CI.
- **Критерии**: проект запускается «по инструкции», понятные фикстуры для разных состояний.

---

### Связанные документы
- Бизнес‑спецификация: `./AquaStream_Business_Spec_v1.1.md`
- Моки: `./mocks.md`
- Платежи/вебхуки: `./payments.md`
- Тесты: Playwright `tests/e2e/smoke.spec.ts`, конфиг `playwright.config.ts`

---

## Приложение A — Критически важные пункты для мобильного UI/UX

### M0. Навигация и зоны нажатия
- **Цель**: снизить промахи и ускорить навигацию.
- **Шаги**: минимум 44×44px hit‑area; увеличенные `Button`/`SelectTrigger`; мобильный `Sheet` для меню/фильтров; фиксированный bottom‑actions там, где уместно.
- **Критерии**: интерактивы удобны одной рукой; меню/фильтры раскрываются в `Sheet` без скролль‑ловушек.

### M0. Списки и таблицы
- **Цель**: читаемость и контроль длины контента.
- **Шаги**: карточная подача списков (вместо таблиц) на xs/sm; перенос длинных строк с `truncate`/`line-clamp`; skeleton‑списки вместо пустого экрана.
- **Критерии**: нет горизонтального скролла; ключевые поля видны без зума.

### M0. Формы и ввод
- **Цель**: минимизировать ошибки ввода.
- **Шаги**: соответствующий `inputmode`/`type` (tel/number/email); крупные поля и расстояния; sticky submit‑bar; валидация по блюру; автоскролл к ошибке.
- **Критерии**: формы проходимы одной рукой; ошибки заметны и исправимы без скролла.

### M1. Медиа и производительность
- **Цель**: быстрые загрузки и экономия трафика.
- **Шаги**: `next/image` с `sizes` под брейкпойнты; lazy для не‑above‑the‑fold; сжатые SVG/иконки; отключение тяжёлых анимаций на `prefers-reduced-motion`.
- **Критерии**: LCP и CLS в норме на мобильных; отсутствие «подпрыгиваний» контента.

### M1. Доступность и жесты
- **Цель**: корректная работа с экранными читалками и жестами.
- **Шаги**: aria‑ролей для кнопок/тогглов; `focus-visible`; семантические списки и заголовки; избегать gesture‑конфликтов (swipe/scroll) в `Sheet/Dialog`.
- **Критерии**: проверки a11y без критики; жесты не мешают скроллу.
