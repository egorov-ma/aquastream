#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-push hook for running tests before pushing
set -e

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_status() {
    echo -e "${GREEN}âœ“${NC} $1"
}

print_info() {
    echo -e "${BLUE}â„¹${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}âš ${NC} $1"
}

print_error() {
    echo -e "${RED}âœ—${NC} $1"
}

echo "ðŸ§ª Running pre-push checks..."

# ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÐºÐ¾Ñ€ÐµÐ½ÑŒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
PROJECT_ROOT="$(git rev-parse --show-toplevel)"

# ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ push
remote="$1"
url="$2"

# Ð§Ð¸Ñ‚Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ refs Ð¸Ð· stdin
while read local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        print_info "Branch deletion detected, skipping tests"
        continue
    fi
    
    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        # ÐÐ¾Ð²Ð°Ñ Ð²ÐµÑ‚ÐºÐ°, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ñ€Ð¾Ñ‚Ð¸Ð² main/master
        if git show-ref --verify --quiet refs/remotes/origin/main; then
            range="origin/main..$local_sha"
        elif git show-ref --verify --quiet refs/remotes/origin/master; then
            range="origin/master..$local_sha"
        else
            range="$local_sha"
        fi
    else
        # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ¹ Ð²ÐµÑ‚ÐºÐ¸
        range="$remote_sha..$local_sha"
    fi
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐµÑÑ‚ÑŒ Ð»Ð¸ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ñ‹ Ð´Ð»Ñ push
    if [ -z "$(git rev-list $range 2>/dev/null)" ]; then
        print_info "No new commits to push"
        continue
    fi
    
    print_info "Checking commits in range: $range"
    
    # ========== FRONTEND TESTS ==========
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² frontend
    FRONTEND_FILES_CHANGED=$(git diff --name-only $range | grep '^frontend/' || true)
    
    if [ -n "$FRONTEND_FILES_CHANGED" ]; then
        echo "ðŸ“ Frontend files changed:"
        echo "$FRONTEND_FILES_CHANGED" | sed 's/^/  /'
        
        cd "$PROJECT_ROOT/frontend"
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ TypeScript ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸ÑŽ
        print_status "Checking TypeScript compilation..."
        if ! npx tsc --noEmit; then
            print_error "TypeScript compilation failed!"
            exit 1
        fi
        
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ñ‹ frontend ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ ÐµÑÑ‚ÑŒ
        if [ -f "package.json" ] && grep -q '"test"' package.json; then
            print_status "Running frontend tests..."
            if timeout 300 npm test -- --watchAll=false --passWithNoTests; then
                print_status "Frontend tests passed!"
            else
                exit_code=$?
                if [ $exit_code -eq 124 ]; then
                    print_error "Frontend tests timed out after 5 minutes"
                else
                    print_error "Frontend tests failed!"
                fi
                exit 1
            fi
        else
            print_warning "No frontend tests configured"
        fi
        
        cd "$PROJECT_ROOT"
    fi
    
    # ========== JAVA BACKEND TESTS ==========
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² Java Ñ„Ð°Ð¹Ð»Ð°Ñ…
    JAVA_FILES_CHANGED=$(git diff --name-only $range | grep '\.java$' || true)
    
    if [ -n "$JAVA_FILES_CHANGED" ]; then
        echo ""
        echo "ðŸ“ Java files changed:"
        echo "$JAVA_FILES_CHANGED" | sed 's/^/  /'
        
        cd "$PROJECT_ROOT"
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸ÑŽ
        if [ -f "gradlew" ] && [ -x "gradlew" ]; then
            print_status "Compiling Java code..."
            if ! ./gradlew compileJava compileTestJava -q; then
                print_error "Java compilation failed! Cannot push broken code."
                exit 1
            fi
            
            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Java Ñ‚ÐµÑÑ‚Ñ‹
            if find . -name "*Test.java" -o -name "*Tests.java" | grep -q .; then
                print_status "Running Java tests..."
                
                if timeout 300 ./gradlew test -q --no-daemon; then
                    print_status "All Java tests passed!"
                else
                    exit_code=$?
                    if [ $exit_code -eq 124 ]; then
                        print_error "Java tests timed out after 5 minutes"
                    else
                        print_error "Java tests failed! Check test results before pushing."
                        
                        # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¾Ñ‚Ñ‡ÐµÑ‚Ñ‹ Ð¾ Ñ‚ÐµÑÑ‚Ð°Ñ… ÐµÑÐ»Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹
                        if [ -d "build/reports/tests/test" ]; then
                            print_info "Test report available at: build/reports/tests/test/index.html"
                        fi
                    fi
                    exit 1
                fi
            else
                print_warning "No Java test files found"
            fi
        elif [ -f "pom.xml" ]; then
            print_info "Running Maven tests..."
            
            if command -v mvn >/dev/null 2>&1; then
                print_status "Compiling Java code..."
                if ! mvn compile test-compile -q; then
                    print_error "Maven compilation failed!"
                    exit 1
                fi
                
                print_status "Running Java tests..."
                if timeout 300 mvn test -q; then
                    print_status "All Maven tests passed!"
                else
                    exit_code=$?
                    if [ $exit_code -eq 124 ]; then
                        print_error "Maven tests timed out after 5 minutes"
                    else
                        print_error "Maven tests failed!"
                    fi
                    exit 1
                fi
            else
                print_error "Maven not found but pom.xml exists"
                exit 1
            fi
        fi
    fi
done

print_status "Pre-push checks completed successfully! ðŸš€"
echo ""