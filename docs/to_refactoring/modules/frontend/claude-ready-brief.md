## AquaStream Frontend — Claude‑ready бриф (v1)

### Цель

- Финализировать фронтенд на базе Tailwind v4 + shadcn/ui: полная унификация визуального слоя, типобезопасность, доступность, производительность, стабильные e2e.
- Исключить расхождения со стандартами проекта и закрепить DoD/тест‑план.

Ссылки (референсы)
- Tailwind v4 (референс по интеграции): [Using Vite](https://tailwindcss.com/docs/installation/using-vite)
- shadcn/ui (Next): https://ui.shadcn.com/docs/installation/next

### Контекст (стек и действующие правила)

- Стек: Next.js 15 (App Router), React 19, TypeScript strict, Tailwind v4 (`@tailwindcss/postcss`), shadcn/ui (Radix), next‑themes, Playwright.
- Темизация: `app/globals.css` с `@theme inline` и токенами (`--background`, `--primary`, …). Только этот CSS; иных .css/.module.css быть не должно.
- Анимации: `tailwindcss-animate` (подключено). Классы состояния в оверлеях должны работать корректно.
- Дизайн‑система: только Tailwind‑утилиты + shadcn/ui. Сырые `<a>`/`<button>` и ручные классы для базовых элементов запрещены.
- Suspense: компоненты на `useSearchParams()` — внутри родительского `<Suspense>` (домашняя — уже обёрнута).
- Рендеринг: SSG/ISR для публичных; SSR для карточек/кабинетов по спецификации.

### Границы (что можно/нельзя трогать)

Разрешённые директории:
- `frontend/app/**` — страницы/роут‑хэндлеры и layout’ы
- `frontend/components/**` — ui‑кит и фичи
- `frontend/lib/**`, `frontend/shared/**` — утилиты/клиенты
- `frontend/tests/e2e/**` — e2e тесты (Playwright)
- `frontend/docs/**` — документация

Запрещено:
- Добавлять новые .css/.scss и CSS‑модули. Все стили — Tailwind утилитами и токенами.
- Вмешиваться в backend/** в рамках этой задачи.

### Ограничения и принципы

- Типобезопасность: TS strict, без `any`, без «пустых» object types (`{}`) в публичных API.
- Доступность (a11y):
  - Фокус‑индикаторы (`focus-visible`), aria‑атрибуты, `aria-sort` на сортируемых заголовках таблиц.
  - Управляемая клавиатурная навигация (обеспечивается Radix/shadcn) — не ломать поведение оверлеев.
- Унификация UI:
  - Кнопки — `Button` / `buttonVariants`, ссылки‑кнопки — `Button asChild`.
  - Поля — `Input`/`Textarea`/`Label`; связки `htmlFor`/`id`, `aria-invalid`/`aria-describedby` где нужно.
  - Контейнеры: статусные — `Alert`; секции/карточки — `Card` (+ `CardContent/Header/Footer`).
  - Ссылки внутри приложения — `Link` (Next.js), без сырых `<a>`.
- Tailwind v4:
  - Только утилиты; произвольные значения — в синтаксисе Tailwind `[prop:value]` и через `var(--*)`.
  - Inline style допустим только для установки CSS‑переменных (например, `--accent`, `--progress`).
- Производительность: контролировать размер первого чанка; тяжёлые блоки (например, EditorJS) — динамически.

### Унификация UI — детализировано

- Семантика и структура
  - Заголовок страницы: `PageHeader` (title/description/actions) сверху секции.
  - Основные блоки контента: `Card` (+ `CardHeader/Content/Footer`) или `Section` (если нужен только отступ/группа без рамки).
  - Статусы/информ‑блоки: `Alert`/`AlertDescription` (варианты: `default|destructive`).
- Базовые элементы
  - Кнопки: только `Button`/`buttonVariants` (link‑кнопки — `variant="link" size="sm" className="p-0 h-auto"`).
  - Поля: `Input`/`Textarea`/`Label` (+ валидность через `aria-invalid`, подсказки через `aria-describedby`).
  - Ссылки: только `Link` для внутренних переходов; `Button asChild` для ссылок‑кнопок.
- Варианты/классы
  - Расширение компонентов — через `cva` (варианты), объединение классов — через `cn`.
  - Data‑состояния: `data-[state=open]`, `data-[side=bottom]`, `data-[selected=true]` и пр. — стандарт шадцн.
- Токены/утилиты Tailwind v4
  - Цвета/радиусы/spacing — только из токенов темы (`@theme inline`) и утилит Tailwind.
  - Произвольные значения — строго в виде `w-[calc(var(--progress)*1%)]`, `border-[var(--accent)]` и т.п.
  - Inline style разрешён лишь для задания переменных `--*`.
- Сетка/отступы
  - Контейнер: `mx-auto max-w-6xl px-4 sm:px-6 lg:px-8` (или уместный `max-w-*`).
  - Отступы между блоками — `gap-*`/`space-*`, без «магических» чисел вне шкалы Tailwind.

### Производительность — детализировано

- Рендеринг и компоненты
  - По умолчанию Server Components; `"use client"` — только для интерактива.
  - SSR/ISR по спецификации маршрутов; избегать лишних клиентских эффектов.
  - Избегать тяжёлых вычислений в рендере; использовать `useMemo`/`useCallback` разумно.
- Кодсплиттинг и загрузка
  - Динамические импорты для тяжёлых блоков (например, EditorJS/графики).
  - Не тянуть весь UI‑набор в каждый маршрут; импортировать компоненты по месту.
  - `prefetch`/ленивая загрузка для второстепенных страниц/виджетов.
- Сеть и ресурсы
  - Изображения — только через `next/image` (remotePatterns уже настроены).
  - Шрифты — `next/font` (уже подключены Geist); без внешних блокирующих ссылок.
  - Предварительные соединения/ресурсы: `preconnect`/`dns-prefetch`/`preload` как нужно для виджетов оплаты (только при реальном провайдере).
- Tailwind/классы
  - Не генерировать динамические строки классов вне списка сканируемых путей (во избежание пропуска стилей).
  - Переиспользовать готовые утилиты вместо кастомных комбинаций.
- Кэш/данные
  - Использовать `cache: 'no-store'` для dev e2e и критичных свежих данных; иначе — `revalidate` по спецификации.
  - В проде — отдавать статику через CDN, включать компрессию.
- Метрики и бюджеты
  - Lighthouse: Performance ≥ 90, LCP < 2.5s, TBT < 200ms, CLS < 0.1.
  - Бюджеты бандла (ориентиры): First Load JS shared by all ≤ ~180–200 kB (по отчёту Next); избегать роста без необходимости.

### Deliverables

- Полностью унифицированный UI (Tailwind v4 + shadcn/ui), без кастомных CSS/модулей.
- Зелёные `pnpm build` и `pnpm lint`.
- Зелёные e2e (Playwright) по основным флоу.
- Краткий гайд для разработчиков (как использовать UI‑кит/утилиты в проекте). 

### План действий (финальный, приоритетный)

1) Быстрые улучшения LCP/CLS (главная и первые экраны)
- Проставить `priority`/`sizes` у ключевых `next/image` на первом экране (hero/обложки).
- Стабилизировать высоты: явные размеры/соотношения у контейнеров изображений, skeleton’ов и карточек, чтобы избежать сдвигов.
- Ленивая подгрузка ниже «фолда» (динамические импорты секций/блоков, отложенный рендер второстепенных списков).
- Аудит `"use client"` и перевод на RSC там, где интерактива нет (снижение First Load JS).

2) Унификация оставшихся контейнеров
- Заменить оставшиеся `rounded-md border p-*` на `Card`/`Alert` по контексту.
- Нормализовать шапки секций через `PageHeader` (title/description/actions) где уместно.

3) Таблицы и фильтры
- Проверить, что во всех таблицах сортировка реализована через `Button variant="link"` и `aria-sort`.
- Фильтры: placeholder/лейблы/aria у инпутов; проверка в e2e.

4) A11y/UX
- Визуальный обзор всех диалогов/меню/tooltip на предмет классов состояний; фокус‑ловушки не нарушены.
- Проверка контрастов токенов темы (светлая/тёмная).

5) Тесты/аудит
- Прогон e2e (уже зелёные) после правок; при необходимости расширить сценарии.
- Запустить Lighthouse и добиться: Performance ≥ 0.90, LCP < 2.5s, CLS < 0.1.
- Зафиксировать отчёт в `./lighthouse.report.json` и приложить в CI артефакты.

6) Инструменты и CI (по желанию)
- Добавить Lighthouse CI шаг в GitHub Actions (thresholds и артефакт отчёта).
- Добавить Storybook для UI‑кита (критично не обязательно, но ускорит ревью визуальных регрессий).

### Чек‑листы по маршрутам

- `/` (главная):
  - Нет сдвигов layout на первом экране; изображения и шрифты оптимизированы (LCP ≤ 2.5s).
  - Пагинация/поиск работают; e2e проходит.
- `/org/[orgSlug]`:
  - `PageHeader` (если нужен), карточки/листы оформлены `Card`.
  - Компоненты фильтров — `Input`/`Button`, a11y (лейблы/placeholder/aria) в порядке.
- `/org/[orgSlug]/events`:
  - Таблица: сортировка через `Button` и `aria-sort`; фильтр уменьшает строки; e2e проходит.
- `/events/[eventId]`:
  - Waitlist/кнопки — shadcn; секции оформлены; SSR по плану.
- `/checkout/[bookingId]`:
  - Виджет/QR: статусные блоки — `Alert`; e2e (успех/отмена) проходят.
- `/auth/*`/`/dashboard`:
  - Кнопки/поля — shadcn; редиректы и guard работают.

### Acceptance Criteria (DoD)

- Стиль:
  - Нет .css/.scss, кроме `app/globals.css`; нет CSS‑модулей; нет «ручных» utility‑групп для базовых элементов.
  - Нет inline style, кроме задания CSS‑переменных.
  - Внутренние переходы — только `Link`.
- Компоненты:
  - `Button`, `Input`, `Textarea`, `Card`, `Alert` — везде по назначению.
  - Сортируемые таблицы: кликабельные заголовки (`Button variant="link"`), `aria-sort` расставлен.
- A11y/UX:
  - Фокус‑индикаторы в интерактиве; aria‑атрибуты в диалогах/меню/tooltip корректны.
  - Компоненты с `useSearchParams()` рендерятся под `<Suspense>`.
- Качество:
  - `pnpm lint` — без ошибок/предупреждений.
  - `pnpm build` — зелёный билд.
  - E2E (ниже) — зелёные.
- Перфоманс/аудит:
  - Lighthouse (локально): Performance ≥ 90, LCP < 2.5s, TBT < 200ms, CLS < 0.1.
  - First Load JS shared by all — без роста относительно текущего отчёта; причины роста — документированы.
  - Нет лишних client‑components; тяжёлые блоки — динамически.

### Тест‑план (Playwright)

Смоук:
- Домашняя страница рендерится; пагинация меняет query‑строку.
- `/org/:slug` отображается.
- `/events/:id` отображается, блок waitlist виден.
- `/auth/login` загружается (кнопка «Войти» в main видна).
- `/dashboard` без сессии редиректит на логин.

Бизнес‑флоу:
- Checkout: виджет — кнопки «Оплатить/Отменить» видимы; по клику показываются соответствующие `Alert`.
- Org events:
  - Сортировка: клик по «Событие» меняет `aria-sort` и порядок строк.
  - Фильтрация: ввод в поле поиска уменьшает количество строк; очистка — возвращает.

Прогон:
- `pnpm exec playwright test --reporter=list`

### План работ (итерации)

1) Быстрая чистка
- Убедиться в отсутствии оставшихся сырых `<a>/<button>` и кастомных контейнеров; заменить на `Link`/`Button` и `Card/Alert`.
- Проверить `aria-sort`/`aria-label` в таблицах.

2) Доступность/перфоманс
- Проверка фокусов, aria; визуальный просмотр оверлеев.
- Динамический импорт тяжёлых блоков; перераздать приоритеты ресурсов при необходимости.

3) Тесты/аудит
- Дополнить e2e (при необходимости), прогнать Lighthouse, зафиксировать отчёт в CI‑артефактах.

### Риски и смягчение

- Расхождение утилит/классов после смены плагина анимаций — покрыто визуальными проверками и e2e в диалогах.
- Тестовая среда/моки: данные могут отличаться между сценами; использовать data‑селекторы и устойчивые локаторы.
- Перфоманс: рост первого чанка — следить за динамическими импортами и dead‑code elimination.
- SSR/ISR: кеширование может скрывать свежие правки — при тестах использовать `cache: 'no-store'` эндпоинты/моки.

### Команды

```bash
pnpm lint
pnpm build
pnpm exec playwright test --reporter=list
NEXT_PUBLIC_USE_MOCKS=true NEXT_PUBLIC_API_BASE_URL=http://localhost:3101 PORT=3101 pnpm dev
```


