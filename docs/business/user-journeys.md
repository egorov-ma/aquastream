# Пользовательские сценарии

## Обзор

Детальное описание типичных путей пользователей в системе AquaStream.

## Сценарий 1: Гость (неавторизованный)

### Цель: Поиск и просмотр событий

**Путь**:
```
1. Главная страница (/) 
   → Каталог организаторов
   → Поиск по названию

2. Страница организатора (/org/[slug])
   → Информация о компании
   → Команда, FAQ
   → Ближайшие события

3. Список событий (/org/[slug]/events)
   → Фильтры: дата, цена, статус
   → Поиск по тексту

4. Карточка события (/events/[id])
   → Детали события
   → Доступность мест
   → Кнопка "Забронировать" → Редирект на регистрацию
```

**Результат**: Регистрация для бронирования

## Сценарий 2: Участник (User)

### 2.1 Регистрация и онбординг

**Путь**:
```
1. /auth/register
   → Заполнение формы (email, password, phone)
   → Отправка формы

2. Автоматический вход
   → Получение JWT
   → Редирект в /dashboard

3. Заполнение профиля (/dashboard/profile)
   → Добавление Telegram (опционально)
   → Верификация через бота: /start <code>
   → Дополнительные поля
```

**Обязательно**: phone ИЛИ telegram для бронирования

### 2.2 Бронирование события

**Путь**:
```
1. Выбор события
   → /events/[id]
   → Проверка доступности мест

2. Создание брони
   → Кнопка "Забронировать"
   → POST /api/bookings
   → Создание PENDING брони (TTL 30 минут)
   → Редирект на /checkout/[bookingId]

3. Оплата (/checkout/[bookingId])
   → Выбор метода: Виджет ИЛИ QR
   
   Вариант А (Виджет):
   → Открытие payment widget (YooKassa/CloudPayments/Stripe)
   → Ввод карточных данных
   → Подтверждение оплаты
   → Webhook → автоматическое подтверждение брони
   
   Вариант Б (QR):
   → Отображение QR кода на счет организатора
   → Загрузка скриншота оплаты
   → Ожидание модерации организатором
   → Telegram уведомление о результате

4. Подтверждение
   → Статус брони: CONFIRMED
   → Telegram уведомление
   → Email с деталями (опционально)
   → Редирект в /dashboard/bookings
```

**Альтернативный сценарий**: Места закончились → добавление в waitlist

### 2.3 Waitlist

**Путь**:
```
1. Попытка бронирования
   → Нет доступных мест
   → Предложение присоединиться к waitlist

2. Присоединение к очереди
   → POST /api/waitlist
   → Сообщение: "Вы в очереди, позиция: #5"
   → Telegram уведомление при добавлении

3. Ожидание
   → Мониторинг позиции в очереди
   → /dashboard/waitlist - отслеживание

4. Уведомление об освобождении
   → Telegram: "Место освободилось! У вас 30 минут"
   → Ссылка на создание брони

5. Создание брони
   → Клик по ссылке → автоматическое создание PENDING
   → Переход на /checkout/[bookingId]
   → Далее стандартный поток оплаты
```

### 2.4 Отмена бронирования

**Путь**:
```
1. Личный кабинет (/dashboard/bookings)
   → Список всех своих бронирований
   → Статусы, даты, суммы

2. Выбор активной брони
   → Детали брони
   → Кнопка "Отменить"

3. Подтверждение отмены
   → Modal с предупреждением
   → Если CONFIRMED - информация о возврате средств
   → Подтверждение

4. Отмена
   → DELETE /api/bookings/[id]
   → Освобождение места
   → Инициация возврата (если оплачено)
   → Обработка waitlist
   → Telegram уведомление
```

## Сценарий 3: Организатор

### 3.1 Создание бренд-страницы

**Путь**:
```
1. Получение роли ORGANIZER
   → Запрос админу через support
   → Админ: /admin/users → PATCH role → ORGANIZER
   → Telegram уведомление о новой роли

2. Создание организатора (/dashboard/organizer/create)
   → Форма:
     - Название компании
     - Slug (URL-friendly, уникальный)
     - Описание
     - Контакты (email, phone, website)
     - Brand color
   → Загрузка лого (через Media Service)
   → Сохранение

3. Управление командой (/org/[slug]/team)
   → /dashboard/organizer/team/add
   → Добавление членов:
     - Имя
     - Роль (инструктор, гид, и т.д.)
     - Фото
     - Био
   → Сохранение → отображение на публичной странице

4. Создание FAQ (/org/[slug]/for-participants)
   → /dashboard/organizer/faq/add
   → Вопрос + ответ
   → Сортировка drag & drop
   → Публикация на странице организатора
```

### 3.2 Создание и публикация события

**Путь**:
```
1. Создание (/dashboard/events/new)
   → Выбор организатора (если несколько)
   → Форма события:
     - Тип (сплав, поход, экспедиция)
     - Название и описание
     - Даты: начало, окончание
     - Локация (текст или координаты)
     - Цена и валюта
     - Вместимость (capacity)
     - Обложка (загрузка через Media)
     - Теги
   → Сохранение как DRAFT

2. Предпросмотр
   → Кнопка "Предпросмотр"
   → Открывается /events/[id] с плашкой "DRAFT"
   → Проверка как выглядит для участников

3. Редактирование
   → Возврат в форму
   → Корректировка деталей
   → Сохранение

4. Публикация
   → Кнопка "Опубликовать"
   → Валидация: все обязательные поля заполнены
   → PATCH /api/events/[id]/publish
   → Статус: PUBLISHED
   → Событие появляется в каталоге
   → Доступно для бронирования
```

### 3.3 Модерация QR-оплат

**Путь**:
```
1. Переход в очередь (/dashboard/organizer/moderation)
   → Список QR-платежей в статусе "submitted"
   → Сортировка по дате создания
   → Счетчик: "К проверке: 5"

2. Проверка платежа
   → Клик на запись
   → Отображение:
     - Детали брони (событие, участник, сумма)
     - Скриншот оплаты (превью + увеличение)
     - Комментарий участника

3. Принятие решения
   → Кнопка "Подтвердить" ИЛИ "Отклонить"
   → Опциональный комментарий
   → Подтверждение действия

4. Обработка
   Accept:
   → Payment status: SUCCEEDED
   → Booking status: CONFIRMED
   → Telegram уведомление участнику: "Оплата подтверждена!"
   
   Reject:
   → Payment status: REJECTED
   → Booking остается PENDING (истечет через TTL)
   → Telegram: "Оплата отклонена: <причина>"
```

### 3.4 Управление экипажами

**Путь**:
```
1. Событие с бронированиями
   → /dashboard/events/[id]/crews
   → Список подтвержденных участников

2. Создание групп
   → Кнопка "Добавить группу"
   → Тип: Экипаж/Палатка/Стол/Автобус
   → Название и capacity
   → Сохранение

3. Назначение участников
   → Drag & drop участника в группу
   → ИЛИ: выбор из dropdown
   → Проверка capacity
   → Сохранение assignment

4. Уведомления
   → Автоматическое Telegram уведомление:
     "Вы назначены в Экипаж #3 на событии XYZ"
```

## Сценарий 4: Админ

### 4.1 Управление ролями

**Путь**:
```
1. Админ-панель (/admin/users)
   → Поиск пользователя по email
   → Список пользователей с ролями

2. Выбор пользователя
   → Клик → детали профиля
   → Текущая роль, история активности

3. Изменение роли
   → Dropdown: USER → ORGANIZER
   → Кнопка "Сохранить"
   → PATCH /api/admin/users/[id]/role

4. Подтверждение
   → Audit log записан
   → Telegram уведомление пользователю:
     "Вам назначена роль Организатор!"
```

## См. также

- [Requirements](requirements.md) - бизнес-требования
- [Processes](processes.md) - процессы
- [Frontend Routing](../frontend/routing.md) - маршруты приложения