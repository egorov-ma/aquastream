# ADR-002: Автогенерация API‑документации (ReDoc + Swagger UI + Spectral)

---
title: ADR-002 - API Documentation Strategy
summary: Генерация ReDoc и Swagger UI из OpenAPI, линтинг Spectral и drift‑check в CI.
tags: [adr, api, documentation, openapi]
---

**Статус:** Accepted
**Дата:** 2025-09-22
**Обновлено:** 2025-10-01 (добавлен Swagger UI)
**Авторы:** Backend Team
**Reviewers:** Team Lead

## Контекст

Контракты хранятся в `docs/api/specs/root/` как OpenAPI YAML. Нужна автогенерация документации для разных use cases:
- **Чтение и изучение API** - красивая, структурированная документация
- **Интерактивное тестирование** - возможность отправлять запросы напрямую из браузера
- **Автопроверка качества** - линтинг спецификаций в CI

Разные инструменты решают разные задачи:
- **ReDoc** - лучший для чтения (компактный, трехколоночный layout)
- **Swagger UI** - лучший для тестирования (Try it out, authorization)

## Решение

### Генерация обоих форматов

Генерируем **и ReDoc, и Swagger UI** для каждой OpenAPI спецификации:

```bash
# tools/generate_api_docs.py
docs/api/specs/root/*.yaml →
  - docs/api/redoc/root/*.html       # ReDoc для чтения
  - docs/api/swagger/root/*.html     # Swagger UI для тестирования
  - docs/api/index.md                # Индекс со ссылками на оба формата
```

### Таблица в index.md

| Модуль | Спецификация | ReDoc (чтение) | Swagger (тестирование) |
|--------|--------------|----------------|------------------------|
| backend-user-api | [YAML](../api/specs/root/backend-user-api.yaml) | [ReDoc](../api/redoc/root/backend-user-api.html) | Swagger UI (в разработке) |

### CI/CD

- Workflow `docs-api.yml`:
  - Генерация ReDoc и Swagger UI
  - Линтинг через `npx @stoplight/spectral-cli lint`
  - Drift-check артефактов

### Использование

- **Для изучения API**: используй ReDoc (компактный, удобный для чтения)
- **Для тестирования**: используй Swagger UI (Try it out, отправка реальных запросов)
- **Для integration тестов**: используй исходные YAML спецификации

## Последствия

### Положительные

- ✅ ReDoc - лучший опыт чтения, трехколоночный layout
- ✅ Swagger UI - интерактивное тестирование без Postman
- ✅ Разработчики могут тестировать API прямо из документации
- ✅ Единый источник правды (OpenAPI YAML)
- ✅ Автопроверка качества спецификаций в CI

### Отрицательные

- ❌ Требуется генерация двух форматов (занимает больше времени)
- ❌ Больше HTML файлов в репозитории (но они в gitignore)
- ❌ Требуются Node.js (Spectral) и Python (генератор)

### Риски

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Swagger UI требует CORS в dev | Medium | Low | Документировать настройку CORS для локального тестирования |
| Дублирование HTML занимает место | Low | Low | HTML файлы в .gitignore, генерируются при сборке |

## Альтернативы

### Вариант 1: Только ReDoc
**Плюсы:**
- ✅ Простота (один формат)
- ✅ Компактная документация

**Минусы:**
- ❌ Нет интерактивного тестирования
- ❌ Разработчики используют отдельно Postman

**Почему не выбран:** Отсутствие интерактивного тестирования снижает productivity

### Вариант 2: Только Swagger UI
**Плюсы:**
- ✅ Интерактивное тестирование
- ✅ Широко известный инструмент

**Минусы:**
- ❌ Менее компактный для чтения
- ❌ Хуже UI для изучения сложных API

**Почему не выбран:** Менее удобен для чтения больших спецификаций

### Вариант 3: Stoplight Elements
**Плюсы:**
- ✅ Современный UI
- ✅ Интерактивные примеры

**Минусы:**
- ❌ Требует более сложной интеграции
- ❌ Меньше community support

**Почему не выбран:** Дополнительная сложность без явных преимуществ

## Мониторинг

**Метрики:**
- Время генерации API docs в CI (должно быть < 2 минут)
- Количество ошибок Spectral lint (должно быть 0)
- Использование: какой формат используется чаще (через analytics)

**Ожидаемые значения:**
- CI build time для docs: < 2 минуты
- Spectral errors: 0
- ReDoc usage > Swagger usage (70/30, так как чтение чаще тестирования)

## Ссылки

**Документация:**
- `docs/api/` - сгенерированная документация
- `docs/api/specs/root/` - исходные OpenAPI спецификации

**Код:**
- `tools/generate_api_docs.py` - генератор документации
- `.github/workflows/docs-api.yml` - CI workflow

**Внешние ресурсы:**
- [ReDoc GitHub](https://github.com/Redocly/redoc)
- [Swagger UI Docs](https://swagger.io/tools/swagger-ui/)
- [Spectral Docs](https://stoplight.io/open-source/spectral)

---
**История изменений:**
- 2025-10-01: Добавлен Swagger UI для интерактивного тестирования (дополнение к ReDoc)
- 2025-09-22: Создание документа - ReDoc + Spectral
