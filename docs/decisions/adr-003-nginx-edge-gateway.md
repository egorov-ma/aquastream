---
title: ADR-003 - Nginx Edge Proxy in Front of Spring Gateway
summary: Выбор Nginx как внешнего reverse proxy перед Spring Cloud Gateway для TLS, безопасности и стандартизации.
tags: [adr, gateway, nginx, networking]
---

# ADR-003: Nginx Edge Proxy перед Spring Gateway

**Статус:** Accepted
**Дата:** 2025-10-06
**Авторы:** Maintainer

## Контекст

Проект AquaStream использует Spring Cloud Gateway как центральную точку маршрутизации между фронтендом и микросервисами. Ожидается публикация приложения в интернет, поэтому требуется стандартная схема с внешним reverse proxy, который завершает TLS, нормализует заголовки, применяет базовые ограничения по трафику и выступает единым входом в инфраструктуру. Пользовательский фронтенд (Next.js) и open-source позиционирование проекта предъявляют требования к предсказуемости, простоте сопровождения и соответствию индустриционным практикам.

Ключевые потребности:
- Завершение HTTPS и управление сертификатами на «границе» периметра.
- Унификация CORS, security headers и rate limiting без усложнения конфигурации Gateway.
- Возможность проксировать статический frontend и API через единую точку.
- Использование максимально популярного решения, чтобы документация проекта выглядела знакомо потенциальным контрибьюторам.

## Решение

Вводится Nginx как edge reverse proxy перед Spring Cloud Gateway. Архитектура трафика:

```
Client → Nginx (80/443) → Spring Cloud Gateway (:8080) → Backend services
                                   ↳ Next.js frontend (:3000) для статических ресурсов
```

Основные договорённости:

1. **Контейнеризация.** Nginx запускается отдельным сервисом Docker Compose (`backend-infra/docker/compose/docker-compose.yml`). Конфигурация хранится в `backend-infra/docker/compose/nginx.conf`, дополнительные артефакты — в `backend-infra/docker/compose/nginx/`.
2. **TLS termination.** Сертификаты (Let’s Encrypt или загруженные вручную) монтируются в каталог `nginx/tls/`; Gateway работает исключительно по HTTP внутри кластера.
3. **Безопасность.** Edge-headers (`Access-Control-Allow-*`, `Strict-Transport-Security`, `X-Frame-Options`) и базовый лимит запросов на IP настраиваются в Nginx. Gateway сохраняет прикладные CORS- и rate-limit политики.
4. **Маршрутизация.**
   - `/api/**` → `backend-gateway:8080`
   - Корень `/` → `frontend:3000` (SSR/статический контент)
   - Дополнительные публичные статические каталоги (например, метрики Prometheus) прокидываются отдельными `location` блоками.
5. **Обслуживание.** Все операции управления описаны в `docs/operations/nginx.md`; рестарт выполняется через `make restart SERVICE=nginx`. Обновления конфига проходят через `nginx -t` + `nginx -s reload` в контейнере.
6. **Логи и мониторинг.** Логи доступа пишутся в stdout контейнера и агрегируются вместе с другими сервисами. Ошибки (4xx/5xx) используются как сигнал для SLO Gateway. Отдельный alert — на рост 502/504.

## Последствия

**Положительные:**
- ✅ Соответствие распространённой схеме «Nginx + Spring Gateway», проще для внешних ревьюеров.
- ✅ Централизованное управление TLS и edge-настройками без модификации приложений.
- ✅ Возможность гибко расширять правила маршрутизации (статический контент, health-check страницы).
- ✅ Улучшенная безопасность: можно добавить WAF- или rate-limit правила на границе.

**Отрицательные:**
- ❌ Дополнительный компонент в цепочке (надо следить за конфигурацией и обновлениями Nginx).
- ❌ Появляется двойной уровень CORS/headers (edge + Gateway) — требуется синхронизация настроек.
- ❌ Нужен операционный контроль за сертификатами (обновление, хранение секретов).

**Риски:**
| Риск | Вероятность | Митигация |
|------|-------------|-----------|
| Несогласованность правил между Nginx и Gateway | Medium | Документировать source-of-truth: edge отвечает за TLS/headers, Gateway — за бизнес-правила. |
| Пропуск обновлений Nginx и уязвимости | Medium | Раз в месяц проверять CVE, обновлять образ, выпускать патч-релиз. |
| Рост латентности при неправильной конфигурации | Low | Держать конфигурацию минимальной, включать gzip только для крупных ответов, мониторить p95. |

## Альтернативы

### Вариант 1: Использовать только Spring Cloud Gateway
**Плюсы:** Меньше компонентов, единая конфигурация в Spring.
**Минусы:** Нет зрелой TLS-терминации, менее гибкое управление статикой и rate limiting.
**Почему не выбран:** Не покрывает требования к edge-уровню, усложняет поддержку сертификатов.

### Вариант 2: Traefik / Envoy вместо Nginx
**Плюсы:** Динамическая конфигурация, встроенный сервис-дискавери.
**Минусы:** Более высокая сложность, меньше специалистов, нет явной потребности в advanced L7-фичах.
**Почему не выбран:** Для одного maintainer и простой схемы Nginx проще и привычнее.

### Вариант 3: Managed ingress (Cloud Load Balancer)
**Плюсы:** SLA провайдера, автоматическое управление TLS.
**Минусы:** Зависимость от облака, сложнее воспроизводимость в open-source.
**Почему не выбран:** Проект позиционируется как self-hosted open-source.

## Связанные решения

- Зависит от: нет
- Влияет на: Gateway operations (`../backend/gateway/operations.md`), операционный регламент (`../operations/nginx.md`, `../operations/deployment.md`)
- Заменяет: Предыдущий implicit flow «client → gateway» без edge-proxy

## Ссылки

- [Nginx Edge Proxy Operations Guide](../operations/nginx.md)
- [Gateway Operations](../backend/gateway/operations.md)
- [Deployment Guide](../operations/deployment.md)
- [Documentation Guidelines — ADR](../_internal/documentation-guidelines.md#architecture-decision-records-adr)
