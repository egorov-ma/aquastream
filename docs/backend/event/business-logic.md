# Event — бизнес-логика

Статус: as-is

## Ответственности
- Управление организаторами и событиями (каталог, даты, вместимость, статус)
- Бронирования и их статусы: PENDING → CONFIRMED/EXPIRED/CANCELLED
- Waitlist для переполненных событий
- Избранное, команда организатора, FAQ

## Потоки бронирования
1. Создание брони
   - Валидация профиля пользователя (phone или Telegram)
   - Проверка доступных мест и дублей активной брони на событие
   - Создание `Booking(PENDING)` с `expiresAt = now()+30m`, декремент доступных мест
2. Оплата
   - Успех вебхука оплаты → `Booking.CONFIRMED`, фиксирование места
   - Ошибка/отмена → бронь остаётся `PENDING` или переводится в `CANCELLED` по политике
3. Истечение
   - Планировщик помечает просроченные как `EXPIRED`, восстанавливает доступные места
   - Триггер уведомлений и обработка очереди ожидания
4. Отмена пользователем/админом
   - `CANCELLED`, освобождение места, возможна нотификация waitlist

## Инварианты
- Не более одной активной брони на пользователя на одно событие
- Доступные места не уходят в минус (атомарное обновление брони и capacity)
- Создание брони — идемпотентно по ключу запроса (при наличии)

## Waitlist
- FIFO, окно 30 минут на подтверждение
- Переход из waitlist в `PENDING` при появлении мест

## Интеграции
- Payment: изменения статуса оплаты синхронизируют статус брони
- Notification: события об успешной оплате/истечении/отмене
- User: чтение профиля/контактов

## Чек‑лист
- [ ] TTL `PENDING` = 30 минут, конфигурируемо
- [ ] Транзакционность при изменении capacity и создании брони
- [ ] Idempotency для создания брони и вебхуков
- [ ] Единый формат ошибок RFC 7807
