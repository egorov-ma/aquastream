# Event Service — Бизнес-логика

## Обзор

Event Service - центральный сервис для управления организаторами, событиями и **бронированиями**. Включает логику waitlist, управление доступными местами и автоматическое истечение бронирований.

## Основные функции

- CRUD организаторов и событий
- Управление бронированиями (PENDING → CONFIRMED → COMPLETED)
- Waitlist (FIFO с окном 30 минут)
- Избранное пользователей
- Команда и FAQ организатора

## Домены

### Организаторы

Управление брендами организаторов мероприятий.

**Поля**: slug (уникальный), name, logo_url, description, contacts (JSON), brand_color

### События

Создание и управление мероприятиями.

**Статусы**: `DRAFT` → `PUBLISHED` → `COMPLETED`/`CANCELLED`

### Бронирования

Ключевая бизнес-логика сервиса.

**Статусы**: `PENDING` (30 мин) → `CONFIRMED` → `COMPLETED`

## Создание бронирования

**Endpoint**: `POST /api/bookings`

**Процесс**:
1. Проверка профиля (phone ИЛИ telegram заполнен)
2. Проверка доступности мест
3. Проверка дублирования (не более одной активной брони)
4. Создание `PENDING` брони с TTL 30 минут
5. Декремент доступных мест (атомарно)
6. Pub/Sub событие для Payment и Notification

**Машина состояний**:
```
PENDING → CONFIRMED (оплата успешна)
PENDING → EXPIRED (30 минут истекло)
PENDING → CANCELLED (отмена пользователем)
CONFIRMED → COMPLETED (событие прошло)
CONFIRMED → CANCELLED (отмена с возвратом)
```

## Scheduled Jobs

### Expire Bookings (каждую минуту)
- Находит PENDING брони с истекшим `expiresAt`
- Переводит в `EXPIRED`
- Освобождает места
- Обрабатывает waitlist
- Отправляет уведомление

### Process Waitlist
- При освобождении мест
- FIFO порядок (по priority)
- Уведомление следующего в очереди
- Окно для брони: 30 минут

## Инварианты
- Не более одной активной брони на пользователя на одно событие
- Доступные места не уходят в минус (атомарное обновление брони и capacity)
- Создание брони — идемпотентно по ключу запроса (при наличии)

## Waitlist
- FIFO, окно 30 минут на подтверждение
- Переход из waitlist в `PENDING` при появлении мест

## Интеграции
- Payment: изменения статуса оплаты синхронизируют статус брони
- Notification: события об успешной оплате/истечении/отмене
- User: чтение профиля/контактов

## База данных (схема `event`)

### Ключевые таблицы

```sql
organizers    - брендстраницы организаторов
events        - мероприятия с capacity/available
bookings      - бронирования (статус, expires_at, payment_status)
booking_logs  - аудит всех изменений броней
waitlist      - очередь ожидания (FIFO)
favorites     - избранные события пользователей
team_members  - команда организатора
faq_items     - FAQ организатора
```

См. [Database](../common/database.md#event-схема) для детальной схемы.

## Безопасность и правила

- ✅ Транзакционность при создании брони + декремент мест
- ✅ Идемпотентность создания (по ключу запроса)
- ✅ TTL брони: 30 минут (конфигурируемо)
- ✅ Инварианты: available >= 0, не более 1 активной брони на событие
- ✅ Audit log всех изменений статуса
- ✅ RFC 7807 для всех ошибок

## См. также

- [Event API](api.md) - REST endpoints
- [Payment Service](../payment/business-logic.md) - интеграция оплаты  
- [Business Processes](../../business/processes.md) - бизнес-процессы бронирования
