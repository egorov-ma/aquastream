# Payment — бизнес-логика

Статус: as-is

## Потоки
1. Инициализация
   - Создание записи `payment` со статусом `NEW` и параметрами (amount, currency, provider)
   - Режимы: `WIDGET` (редирект/виджет), `QR_MANUAL` (показ QR и загрузка чека)
2. Обработка вебхуков
   - Проверка подписи/секрета провайдера
   - Идемпотентность по ключу события → запись в `webhook_events`
   - Обновление статуса платежа и публикация доменного события
3. Сопоставление с бронью
   - `SUCCESS` → подтверждение брони в Event
   - `FAILED/CANCELED` → правила рекавери (оставить `PENDING`, авто‑отмена по TTL)
4. Ручная модерация proof
   - Для `QR_MANUAL`: проверка `payment_receipts`, принятие/отклонение

## Статусы
- `NEW` → `PENDING` → `SUCCESS` | `FAILED` | `CANCELED`
- Маппинг к Event.Booking: `SUCCESS` → `CONFIRMED`

## Провайдеры
- YooKassa, CloudPayments, Stripe (через адаптеры)

## Безопасность и соответствие
- Сверка суммы/валюты и idempotency ключей
- Верификация источника вебхука (IP/подпись)
- Маскирование чувствительных полей в логах

## Retention
- `payment_receipts` (proof) — хранение 90 дней

## Чек‑лист
- [ ] Подписи вебхуков проверяются для всех провайдеров
- [ ] Idempotency: вебхуки и init‑запросы не приводят к дублям
- [ ] Консистентность с Event (саги/ретраи при сбоях)
