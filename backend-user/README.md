# Сервис аутентификации и управления пользователями (backend-user)

![Java](../common/src/main/resources/static/images/java.svg)
![Gradle](../common/src/main/resources/static/images/gradle.svg)
![Spring Boot](../common/src/main/resources/static/images/spring-boot.svg)
![JWT](../common/src/main/resources/static/images/jwt.svg)
![Swagger](../common/src/main/resources/static/images/swagger.svg)
![Kafka](../common/src/main/resources/static/images/kafka.svg)
![PostgreSQL](../common/src/main/resources/static/images/postgresql.svg)
![Docker](../common/src/main/resources/static/images/docker.svg)
![Prometheus](../common/src/main/resources/static/images/prometheus.svg)
![Grafana](../common/src/main/resources/static/images/grafana.svg)

## Описание

Сервис отвечает за управление пользователями, аутентификацию и авторизацию в системе Aquastream. Реализует безопасные механизмы управления учетными записями пользователей на основе JWT (JSON Web Tokens) с разделением прав доступа по ролям.

## Функциональные возможности

- **Аутентификация и авторизация**: Безопасное управление доступом на основе JWT токенов
- **Управление пользователями**: Создание, обновление и получение информации о пользователях
- **Ролевая модель**: Разграничение прав доступа (пользователь, организатор, администратор)
- **Интеграция с Telegram**: Возможность связать аккаунт с Telegram для получения уведомлений
- **События**: Публикация событий о регистрации пользователей через Kafka для других сервисов
- **Мониторинг**: Интеграция с Prometheus и Grafana для сбора и визуализации метрик
- **Swagger/OpenAPI**: Автоматическая генерация документации API

## Технический стек

- **Java 21**: Современная версия языка с поддержкой виртуальных потоков и улучшенной производительностью
- **Gradle 7.6+**: Система сборки проекта
- **Spring Boot 3.2.0**: Фреймворк для создания веб-приложений
- **Spring Security**: Аутентификация и авторизация
- **Spring Data JPA**: Доступ к данным
- **Spring Cloud**: Интеграция с другими сервисами
- **Kafka**: Обмен сообщениями с другими сервисами
- **PostgreSQL**: Реляционная база данных
- **Liquibase**: Миграции базы данных
- **Swagger/OpenAPI**: Документация API
- **JWT**: Безопасные токены аутентификации
- **Lombok**: Уменьшение шаблонного кода
- **Docker**: Контейнеризация приложения
- **Prometheus**: Мониторинг метрик приложения
- **Grafana**: Визуализация метрик и создание дашбордов
- **JUnit 5**: Фреймворк для тестирования
- **Mockito**: Создание mock-объектов для тестов
- **TestContainers**: Интеграционное тестирование с использованием контейнеров

## Модель данных

### Сущность пользователя (User)

| Поле            | Тип          | Описание                                    |
|-----------------|--------------|---------------------------------------------|
| id              | UUID         | Уникальный идентификатор пользователя       |
| name            | VARCHAR(50)  | Имя пользователя                            |
| username        | VARCHAR(20)  | Логин пользователя (уникальный)             |
| password        | VARCHAR(120) | Хэш пароля                                  |
| telegram_user   | VARCHAR(50)  | Имя пользователя в Telegram (опциональное)  |
| telegram_chat_id| VARCHAR(50)  | ID чата Telegram для уведомлений            |
| phone           | VARCHAR(20)  | Номер телефона                              |
| role            | ENUM         | Роль пользователя (USER, ORGANIZER, ADMIN)  |
| is_active       | BOOLEAN      | Флаг активации аккаунта                     |
| created_at      | TIMESTAMP    | Дата создания                               |
| updated_at      | TIMESTAMP    | Дата последнего обновления                  |

### Роли пользователей

- **ROLE_USER**: Стандартный пользователь с базовыми правами
- **ROLE_ORGANIZER**: Организатор мероприятий с расширенными правами
- **ROLE_ADMIN**: Администратор с полным доступом к системе

## API Endpoints

API сервиса доступно через:

- **Swagger UI**: `http://localhost:8081/swagger-ui.html` - интерактивная документация API
- **OpenAPI 3.0**: `http://localhost:8081/v3/api-docs` - спецификация в формате JSON
- **OpenAPI 3.0 YAML**: `http://localhost:8081/v3/api-docs.yaml` - спецификация в формате YAML

При запуске в Docker контейнере (через docker-compose):
- **Swagger UI**: `http://localhost:8081/swagger-ui.html`
- **API Gateway**: `http://localhost:8080` (проксирует все сервисы через единую точку входа)

### Swagger/OpenAPI

Swagger UI предоставляет удобный интерфейс для изучения и тестирования API:

1. **Авторизация в Swagger UI**:
   - Откройте `http://localhost:8081/swagger-ui.html`
   - Выполните авторизацию с помощью endpoint `/api/auth/signin`
   - Скопируйте полученный JWT токен
   - Нажмите на кнопку "Authorize" в верхней части страницы
   - Введите токен в формате `Bearer {ваш_токен}` и нажмите "Authorize"

2. **Использование документации**:
   - После авторизации вы можете тестировать все API эндпоинты
   - Документация разделена по тегам (auth, users, admin)
   - Для каждого эндпоинта доступно описание, параметры, тело запроса и возможные ответы
   - Вы можете выполнять запросы непосредственно из интерфейса Swagger UI

3. **Загрузка спецификации OpenAPI**:
   - Для использования в других инструментах (Postman, инструменты генерации кода)
   - JSON: `http://localhost:8081/v3/api-docs`
   - YAML: `http://localhost:8081/v3/api-docs.yaml`

### Аутентификация

| Метод | Endpoint               | Описание                                      | Роли                | Коды ответа                                                    |
|-------|-----------------------|----------------------------------------------|---------------------|----------------------------------------------------------------|
| POST  | /api/auth/signin      | Вход в систему                               | Все                 | 200 - Успех, 401 - Неверные учетные данные                      |
| POST  | /api/auth/signup      | Регистрация нового пользователя              | Все                 | 200 - Успех, 400 - Некорректные данные                          |
| GET   | /api/auth/static-tokens | Получение статических токенов (для тестов)   | Все                 | 200 - Успех                                                     |

### Управление пользователями

| Метод | Endpoint                   | Описание                                 | Роли                | Коды ответа                                                    |
|-------|---------------------------|------------------------------------------|---------------------|----------------------------------------------------------------|
| GET   | /api/users/me             | Получение информации о текущем пользователе| Авторизованные      | 200 - Успех, 401 - Не авторизован                              |
| PUT   | /api/users/me             | Обновление профиля текущего пользователя  | Авторизованные      | 200 - Успех, 400 - Некорректные данные, 401 - Не авторизован   |
| GET   | /api/users/{id}           | Получение информации о пользователе по ID | ADMIN               | 200 - Успех, 403 - Запрещено, 404 - Не найден                  |
| PUT   | /api/users/{id}/roles     | Изменение роли пользователя               | ADMIN               | 200 - Успех, 403 - Запрещено, 404 - Не найден                  |
| PUT   | /api/users/{id}/activate  | Активация учетной записи пользователя     | ADMIN               | 200 - Успех, 403 - Запрещено, 404 - Не найден                  |
| PUT   | /api/users/{id}/deactivate| Деактивация учетной записи пользователя   | ADMIN               | 200 - Успех, 403 - Запрещено, 404 - Не найден                  |

### Административные операции

| Метод | Endpoint                   | Описание                                 | Роли                | Коды ответа                                                    |
|-------|---------------------------|------------------------------------------|---------------------|----------------------------------------------------------------|
| GET   | /api/admin/users          | Получение списка всех пользователей       | ADMIN               | 200 - Успех, 403 - Запрещено                                   |

## Безопасность

### Аутентификация

Сервис использует JWT (JSON Web Tokens) для аутентификации:

1. Клиент отправляет логин и пароль на `/api/auth/signin`
2. Сервер проверяет учетные данные и возвращает JWT токен
3. Клиент использует токен в заголовке `Authorization: Bearer {token}` для последующих запросов

### Параметры JWT

- **Время жизни токена**: 24 часа (настраивается)
- **Алгоритм подписи**: HMAC SHA-256
- **Информация в токене**: ID пользователя, имя пользователя, роль

### Обработка ошибок

Сервис использует стандартные HTTP-коды состояния и предоставляет детальные сообщения об ошибках:

| Код состояния | Описание                               | Пример использования                                   |
|---------------|----------------------------------------|--------------------------------------------------------|
| 200 OK        | Успешный запрос                        | Получение информации о пользователе                    |
| 201 Created   | Ресурс успешно создан                  | Регистрация нового пользователя                        |
| 400 Bad Request| Некорректный запрос                    | Отсутствуют обязательные поля или неверный формат данных|
| 401 Unauthorized| Требуется аутентификация              | Доступ к защищенному ресурсу без токена               |
| 403 Forbidden | Доступ запрещен                         | Попытка доступа к ресурсу без необходимых прав        |
| 404 Not Found | Ресурс не найден                        | Запрос пользователя с несуществующим ID               |
| 409 Conflict  | Конфликт при обработке запроса          | Попытка создать пользователя с существующим username  |
| 500 Internal Server Error | Внутренняя ошибка сервера    | Непредвиденная ошибка на сервере                      |

## События

Сервис публикует следующие события в Kafka:

| Событие                | Топик              | Описание                                  |
|------------------------|--------------------|--------------------------------------------|
| USER_REGISTRATION     | user-registration  | Создание нового пользователя               |

## Конфигурация

### Основные параметры

```yaml
# Настройки сервера
server:
  port: 8081

# Настройки приложения
spring:
  application:
    name: user-service
  
  # Настройки базы данных
  datasource:
    url: jdbc:postgresql://localhost:5432/aquastream_db
    username: postgres
    password: postgres
    
  # Настройки JPA
  jpa:
    hibernate:
      ddl-auto: none
      
  # Настройки Liquibase
  liquibase:
    change-log: classpath:db/changelog/db.changelog-master.xml
    
  # Настройки Kafka
  kafka:
    bootstrap-servers: localhost:9092
    topics:
      user-registration: user-registration

# Настройки JWT
jwt:
  secret: your-secret-key
  expiration-ms: 86400000  # 24 часа

# Настройки Swagger/OpenAPI
springdoc:
  swagger-ui:
    path: /swagger-ui.html

# Настройки мониторинга (Actuator)
management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}
```

## Логирование

Сервис использует централизованную систему логирования на базе ELK Stack (Elasticsearch, Logstash, Kibana). 
Подробная документация по настройке и использованию логирования доступна в [документации общего модуля](../common/README.md#логирование-и-мониторинг-elk-stack).

### Основные возможности
- Структурированное JSON-логирование
- Централизованный сбор и анализ логов
- Визуализация через Kibana
- Полнотекстовый поиск по логам

### Конфигурация логирования

```yaml
# Настройки логирования
logging:
  level:
    root: INFO
    org.aquastream: DEBUG
  pattern:
    console: "%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

# Настройки Logstash
logstash:
  host: ${LOGSTASH_HOST:localhost}
  port: ${LOGSTASH_PORT:5000}
```

### Примеры использования

```java
@Slf4j
@RestController
public class UserController {
    
    @GetMapping("/api/users/{id}")
    public UserResponse getUser(@PathVariable UUID id) {
        log.info("Получение пользователя", 
            kv("userId", id),
            kv("action", "get_user"));
        // ...
    }
}
```

## Запуск приложения

### Требования

- JDK 21+
- Gradle 7.6+
- PostgreSQL 14+
- Kafka 3.0+
- Docker и Docker Compose (для контейнеризации)

### Локальный запуск

```bash
# Клонирование репозитория
git clone https://github.com/egorov-ma/aquastream.git
cd aquastream/backend-user

# Сборка проекта с Gradle
./gradlew clean build

# Запуск
java -jar build/libs/backend-user-1.0.0.jar
```

### Запуск в Docker

```bash
# Сборка Docker образа
docker build -t aquastream/backend-user .

# Запуск контейнера
docker run -p 8081:8081 aquastream/backend-user
```

### Запуск через Docker Compose

Для запуска всех сервисов, включая PostgreSQL, Kafka, API Gateway, и другие компоненты:

```bash
# Переход в директорию с docker-compose
cd aquastream/infra/docker/compose

# Запуск всех сервисов
docker-compose up -d

# Запуск только сервиса пользователей и необходимых зависимостей
docker-compose up -d postgres kafka user-service
```

Основные сервисы будут доступны по следующим адресам:

- **API Gateway**: http://localhost:8080
- **User Service**: http://localhost:8081
- **Swagger UI**: http://localhost:8081/swagger-ui.html
- **Prometheus**: http://localhost:9091
- **Grafana**: http://localhost:3001

## Тестирование

### Автоматические тесты

```bash
# Запуск модульных тестов с Gradle
./gradlew test

# Запуск интеграционных тестов
./gradlew integrationTest
```

### Тестирование API

Для тестирования API можно использовать:

1. **Swagger UI**: Доступен по адресу `http://localhost:8081/swagger-ui.html`
2. **Статические токены**: Используйте эндпоинт `/api/auth/static-tokens` для получения тестовых токенов
3. **Postman**: Импортируйте коллекцию из `docs/api/postman/user-service.postman_collection.json`

### Пример запроса аутентификации

```bash
curl -X POST http://localhost:8081/api/auth/signin \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
```

## Мониторинг и логирование

### Метрики приложения

Сервис интегрирован с Prometheus для сбора следующих метрик:

- **JVM метрики**: Использование памяти, сборка мусора, загрузка классов
- **Системные метрики**: Использование CPU, дисковое пространство
- **HTTP метрики**: Время ответа, количество запросов, статус ответов
- **Бизнес-метрики**: Количество пользователей, частота аутентификаций

Метрики доступны через эндпоинт: `http://localhost:8081/actuator/prometheus`

### Дашборды Grafana

Для мониторинга сервиса настроены следующие дашборды Grafana:

1. **User Service Overview**: Общая информация о работе сервиса
   - Доступность сервиса
   - Время отклика API
   - Количество запросов
   - Ошибки сервиса

2. **User Service JVM Metrics**: Мониторинг JVM
   - Использование памяти
   - Сборка мусора
   - Загрузка классов
   - Использование CPU

3. **User Service Business Metrics**: Бизнес-метрики
   - Количество регистраций
   - Количество авторизаций
   - Соотношение активных/неактивных пользователей
   - Распределение ролей пользователей

Дашборды доступны через Grafana по адресу: `http://localhost:3001`

### Настройка мониторинга

Для настройки системы мониторинга необходимо:

1. Запустить стек мониторинга:
```bash
cd aquastream/infra/docker/compose
docker-compose up -d prometheus grafana
```

2. Открыть Grafana: `http://localhost:3001`
   - Логин: admin
   - Пароль: admin

3. Импортировать дашборды из `infra/monitoring/grafana/dashboards`

## Интеграция с другими сервисами

- **Eureka**: Регистрация сервиса в службе обнаружения
- **Kafka**: Отправка событий регистрации пользователей
- **API Gateway**: Маршрутизация запросов через единую точку входа
- **Prometheus**: Экспорт метрик для мониторинга
- **Grafana**: Визуализация метрик в дашбордах

## Разработка

### Структура проекта

```
backend-user/
├── build.gradle                  # Конфигурация сборки Gradle
├── src/
│   ├── main/
│   │   ├── java/org/aquastream/user/
│   │   │   ├── config/           # Конфигурационные классы
│   │   │   │   ├── KafkaConfig.java          # Настройки Kafka
│   │   │   │   ├── OpenApiConfig.java        # Конфигурация Swagger/OpenAPI
│   │   │   │   └── WebSecurityConfig.java    # Настройки безопасности
│   │   │   ├── controller/       # API контроллеры
│   │   │   │   ├── AdminController.java      # Административные операции
│   │   │   │   ├── AuthController.java       # Аутентификация
│   │   │   │   └── UserController.java       # Управление пользователями
│   │   │   ├── dto/              # Объекты передачи данных
│   │   │   │   ├── UserDto.java              # DTO пользователя
│   │   │   │   ├── UserProfileDto.java       # DTO профиля пользователя
│   │   │   │   ├── request/      # DTO для запросов
│   │   │   │   │   ├── LoginRequest.java     # Запрос на вход
│   │   │   │   │   ├── SignupRequest.java    # Запрос на регистрацию
│   │   │   │   │   ├── UpdateUserRequest.java # Запрос на обновление профиля
│   │   │   │   │   └── UserRoleRequest.java  # Запрос на изменение роли
│   │   │   │   └── response/     # DTO для ответов
│   │   │   │       ├── JwtResponse.java     # Ответ с JWT токеном
│   │   │   │       ├── MessageResponse.java # Ответ с сообщением
│   │   │   │       └── UserResponse.java    # Ответ с данными пользователя
│   │   │   ├── entity/           # Сущности базы данных
│   │   │   │   ├── ERole.java    # Enum ролей
│   │   │   │   └── User.java     # Модель пользователя
│   │   │   ├── event/            # Обработка событий Kafka
│   │   │   │   ├── UserEventProducer.java   # Отправка событий
│   │   │   │   └── UserRegistrationEvent.java # Событие регистрации пользователя
│   │   │   ├── repository/       # Репозитории данных
│   │   │   │   └── UserRepository.java      # Доступ к данным пользователей
│   │   │   ├── security/         # Безопасность и JWT
│   │   │   │   ├── jwt/          # Компоненты JWT
│   │   │   │   │   ├── AuthEntryPointJwt.java # Обработка ошибок аутентификации
│   │   │   │   │   ├── AuthTokenFilter.java   # Фильтр JWT токенов
│   │   │   │   │   └── JwtUtils.java          # Утилиты для работы с JWT
│   │   │   │   └── services/     # Сервисы безопасности
│   │   │   │       ├── UserDetailsImpl.java   # Реализация UserDetails
│   │   │   │       └── UserDetailsServiceImpl.java # Реализация UserDetailsService
│   │   │   ├── service/          # Бизнес-логика
│   │   │   │   └── UserService.java         # Сервис пользователей
│   │   │   └── UserApplication.java         # Главный класс приложения
│   │   └── resources/
│   │       ├── application.yml              # Основная конфигурация
│   │       ├── application-docker.yml       # Конфигурация для Docker
│   │       └── db/                          # Ресурсы для базы данных
│   │           └── changelog/               # Файлы изменений Liquibase
│   │               ├── db.changelog-master.xml # Главный файл изменений
│   │               └── changes/             # Детальные изменения
│   │                   ├── 001-create-user-tables.xml # Создание таблиц пользователей
│   │                   └── 002-create-admin-user.xml  # Создание администратора
│   └── test/                     # Тесты
│       ├── java/org/aquastream/user/
│       │   └── controller/            # Тесты контроллеров
│       │       └── UserControllerTest.java # Тесты UserController
│       └── resources/               # Тестовые ресурсы
│           └── application-test.yml  # Тестовая конфигурация
├── docs/                         # Документация
│   └── api/                      # Документация API
│       └── postman/              # Коллекции Postman
│           └── user-service.postman_collection.json # Коллекция API эндпоинтов
└── README.md                     # Документация
```

### Соглашения о коде

- **Стиль кода**: Соответствует Java Code Conventions и Spring Framework Code Style
- **Документация**: Javadoc для всех публичных методов и классов
- **Тесты**: Покрытие кода тестами не менее 80%
- **Обработка ошибок**: Глобальная обработка исключений через `@ExceptionHandler`
- **Логирование**: Использование SLF4J с уместными уровнями логирования
- **Версионирование API**: Использование семантического версионирования для API

## Планы по развитию

### Краткосрочные задачи (1-3 месяца)

- [ ] **Расширение мониторинга**: Добавление бизнес-метрик для отслеживания активности пользователей
- [ ] **Двухфакторная аутентификация**: Поддержка 2FA через SMS или приложения-аутентификаторы
- [ ] **Улучшение тестирования**: Увеличение покрытия кода тестами до 90%
- [ ] **Интеграция с LDAP/AD**: Поддержка корпоративных систем аутентификации
- [ ] **Расширенное управление сессиями**: Просмотр активных сессий пользователя и возможность их завершения
- [ ] **Улучшение безопасности**: Внедрение проверки паролей на утечки и оценку сложности

### Среднесрочные задачи (3-6 месяцев)

- [ ] **Миграция на OAuth 2.0**: Внедрение более гибкой системы авторизации
- [ ] **Улучшение производительности**: Оптимизация запросов и кэширование
- [ ] **API-ключи**: Поддержка API-ключей для системной интеграции
- [ ] **Аудит действий**: Расширенное логирование всех действий пользователей для аудита
- [ ] **Интеграция с системами мониторинга**: Расширение интеграции с ELK Stack и APM решениями

### Долгосрочные планы (6+ месяцев)

- [ ] **Система управления ролями**: Динамическое управление ролями и разрешениями
- [ ] **Поддержка социальных сетей**: Авторизация через социальные сети и внешние провайдеры
- [ ] **Федеративная аутентификация**: Поддержка SAML и других протоколов федеративной аутентификации
- [ ] **Многофакторная аутентификация**: Расширенные возможности многофакторной аутентификации
- [ ] **Аналитика безопасности**: Обнаружение подозрительной активности и предотвращение атак

## Лицензия

Проект распространяется под лицензией `// TODO подумать, а надо оно мне вообще`. Подробности в файле [LICENSE](../LICENSE).

## Авторы

- **Команда разработки AquaStream**
  - Контакт: https://t.me/egorovma

## Вклад в проект

Мы приветствуем вклад в проект! Пожалуйста, ознакомьтесь с руководством по участию в разработке в файле [CONTRIBUTING.md](../CONTRIBUTING.md). 
