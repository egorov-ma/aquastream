# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Alertmanager –¥–ª—è AquaStream
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

global:
  # SMTP –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@aquastream.company.com'
  smtp_auth_username: 'alerts@aquastream.company.com'
  smtp_auth_password: '${SMTP_AUTH_PASSWORD}'  # –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è!
  smtp_auth_secret: '${SMTP_AUTH_PASSWORD}'
  smtp_require_tls: true

  # Slack –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ)
  slack_api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'

# –®–∞–±–ª–æ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∞–ª–µ—Ä—Ç–æ–≤
route:
  # –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s          # –û–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –ø–µ—Ä–≤–æ–≥–æ –∞–ª–µ—Ä—Ç–∞ –≤ –≥—Ä—É–ø–ø–µ
  group_interval: 10s      # –ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏
  repeat_interval: 1h      # –ü–æ–≤—Ç–æ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

  # –ü–æ–ª—É—á–∞—Ç–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  receiver: 'web.hook'

  # –ú–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∞–ª–µ—Ä—Ç–æ–≤
  routes:
    # üö® –ö–†–ò–¢–ò–ß–ù–´–ï –ê–õ–ï–†–¢–´ - –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 5s
      repeat_interval: 5m

    # üîí –ê–õ–ï–†–¢–´ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò - –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª
    - match:
        category: security
      receiver: 'security-team'
      group_wait: 5s
      repeat_interval: 15m

    # üè• –ê–õ–ï–†–¢–´ –ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–´
    - match:
        category: infrastructure
      receiver: 'ops-team'
      group_wait: 30s
      repeat_interval: 30m

    # üìä –ê–õ–ï–†–¢–´ –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò
    - match:
        category: performance
      receiver: 'performance-alerts'
      group_wait: 1m
      repeat_interval: 1h

    # üíæ –ê–õ–ï–†–¢–´ –†–ï–ó–ï–†–í–ù–û–ì–û –ö–û–ü–ò–†–û–í–ê–ù–ò–Ø
    - match:
        category: backup
      receiver: 'backup-alerts'
      group_wait: 5m
      repeat_interval: 12h

    # üíº BUSINESS –ê–õ–ï–†–¢–´
    - match:
        category: business
      receiver: 'business-alerts'
      group_wait: 5m
      repeat_interval: 2h

# –ü–æ–ª—É—á–∞—Ç–µ–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
receivers:
  # –ó–∞–≥–ª—É—à–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  - name: 'web.hook'
    webhook_configs:
      - url: 'http://localhost:5001/'
        send_resolved: true

  # üö® –ö–†–ò–¢–ò–ß–ù–´–ï –ê–õ–ï–†–¢–´ - –º—É–ª—å—Ç–∏–∫–∞–Ω–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  - name: 'critical-alerts'
    # Email –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∞–ª–µ—Ä—Ç–æ–≤
    email_configs:
      - to: 'ops-oncall@company.com,security@company.com'
        subject: 'üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ê–õ–ï–†–¢ AquaStream: {{ .GroupLabels.alertname }}'
        body: |
          üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ê–õ–ï–†–¢ –≤ —Å–∏—Å—Ç–µ–º–µ AquaStream

          –ê–ª–µ—Ä—Ç: {{ .GroupLabels.alertname }}
          –°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å: {{ .CommonLabels.severity }}
          –°–µ—Ä–≤–∏—Å: {{ .CommonLabels.service }}
          
          –î–µ—Ç–∞–ª–∏:
          {{ range .Alerts }}
          - {{ .Annotations.summary }}
            {{ .Annotations.description }}
            –í—Ä–µ–º—è: {{ .StartsAt.Format "02.01.2006 15:04:05" }}
          {{ end }}

          –°—Å—ã–ª–∫–∞ –Ω–∞ –¥–∞—à–±–æ—Ä–¥: http://localhost/monitoring/grafana/
          Runbook: {{ .CommonAnnotations.runbook_url }}

    # Slack –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∞–ª–µ—Ä—Ç–æ–≤
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/CRITICAL/WEBHOOK'
        channel: '#alerts-critical'
        title: 'üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ê–õ–ï–†–¢ AquaStream'
        text: |
          *–ê–ª–µ—Ä—Ç:* {{ .GroupLabels.alertname }}
          *–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:* {{ .CommonLabels.severity }}
          *–°–µ—Ä–≤–∏—Å:* {{ .CommonLabels.service }}
          
          {{ range .Alerts }}
          ‚Ä¢ {{ .Annotations.summary }}
          {{ end }}
        send_resolved: true

  # üîí –ê–õ–ï–†–¢–´ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò
  - name: 'security-team'
    email_configs:
      - to: 'security@company.com'
        subject: 'üîí Security Alert: {{ .GroupLabels.alertname }}'
        body: |
          üîí –ê–õ–ï–†–¢ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò AquaStream

          –¢–∏–ø –∞—Ç–∞–∫–∏: {{ .CommonLabels.attack_type }}
          –ê–ª–µ—Ä—Ç: {{ .GroupLabels.alertname }}
          
          {{ range .Alerts }}
          {{ .Annotations.summary }}
          {{ .Annotations.description }}
          
          –í—Ä–µ–º—è: {{ .StartsAt.Format "02.01.2006 15:04:05" }}
          {{ end }}
          
          –¢–†–ï–ë–£–ï–¢–°–Ø –ù–ï–ú–ï–î–õ–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê!
          
          –õ–æ–≥–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: http://localhost/monitoring/kibana/
          Runbook: {{ .CommonAnnotations.runbook_url }}

    slack_configs:
      - channel: '#security-alerts'
        title: 'üîí Security Alert'
        text: |
          *–¢–∏–ø:* {{ .CommonLabels.attack_type }}
          *–ê–ª–µ—Ä—Ç:* {{ .GroupLabels.alertname }}
          
          {{ range .Alerts }}
          ‚Ä¢ {{ .Annotations.summary }}
          {{ end }}

  # üè• –ê–õ–ï–†–¢–´ –ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–´
  - name: 'ops-team'
    email_configs:
      - to: 'ops@company.com'
        subject: 'üè• Infrastructure Alert: {{ .GroupLabels.alertname }}'
        body: |
          üè• –ê–õ–ï–†–¢ –ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–´ AquaStream

          –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: {{ .CommonLabels.component }}
          –ê–ª–µ—Ä—Ç: {{ .GroupLabels.alertname }}
          
          {{ range .Alerts }}
          {{ .Annotations.summary }}
          {{ .Annotations.description }}
          {{ end }}
          
          –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: http://localhost/monitoring/grafana/

    slack_configs:
      - channel: '#ops-alerts'
        title: 'üè• Infrastructure Alert'
        text: |
          *–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:* {{ .CommonLabels.component }}
          *–ê–ª–µ—Ä—Ç:* {{ .GroupLabels.alertname }}
          
          {{ range .Alerts }}
          ‚Ä¢ {{ .Annotations.summary }}
          {{ end }}

  # üìä –ê–õ–ï–†–¢–´ –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò
  - name: 'performance-alerts'
    slack_configs:
      - channel: '#performance'
        title: 'üìä Performance Alert'
        text: |
          *–†–µ—Å—É—Ä—Å:* {{ .CommonLabels.resource }}
          *–ê–ª–µ—Ä—Ç:* {{ .GroupLabels.alertname }}
          
          {{ range .Alerts }}
          ‚Ä¢ {{ .Annotations.summary }}
          {{ end }}

  # üíæ –ê–õ–ï–†–¢–´ –†–ï–ó–ï–†–í–ù–û–ì–û –ö–û–ü–ò–†–û–í–ê–ù–ò–Ø
  - name: 'backup-alerts'
    email_configs:
      - to: 'ops@company.com'
        subject: 'üíæ Backup Alert: {{ .GroupLabels.alertname }}'
        body: |
          üíæ –ê–õ–ï–†–¢ –†–ï–ó–ï–†–í–ù–û–ì–û –ö–û–ü–ò–†–û–í–ê–ù–ò–Ø

          –°–µ—Ä–≤–∏—Å: {{ .CommonLabels.service }}
          
          {{ range .Alerts }}
          {{ .Annotations.summary }}
          {{ .Annotations.description }}
          {{ end }}
          
          –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∏—Å—Ç–µ–º—É —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è!

    slack_configs:
      - channel: '#ops-alerts'
        title: 'üíæ Backup Alert'
        text: |
          *–°–µ—Ä–≤–∏—Å:* {{ .CommonLabels.service }}
          
          {{ range .Alerts }}
          ‚Ä¢ {{ .Annotations.summary }}
          {{ end }}

  # üíº BUSINESS –ê–õ–ï–†–¢–´
  - name: 'business-alerts'
    email_configs:
      - to: 'product@company.com,management@company.com'
        subject: 'üíº Business Alert: {{ .GroupLabels.alertname }}'
        body: |
          üíº BUSINESS –ê–õ–ï–†–¢ AquaStream

          –ú–µ—Ç—Ä–∏–∫–∞: {{ .CommonLabels.type }}
          
          {{ range .Alerts }}
          {{ .Annotations.summary }}
          {{ .Annotations.description }}
          {{ end }}
          
          –ê–Ω–∞–ª–∏—Ç–∏–∫–∞: http://localhost/monitoring/grafana/

# –ü–æ–¥–∞–≤–ª–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –∞–ª–µ—Ä—Ç–æ–≤
inhibit_rules:
  # –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä down, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∞–ª–µ—Ä—Ç—ã –æ –≤—ã—Å–æ–∫–æ–º CPU/–ø–∞–º—è—Ç–∏
  - source_match:
      alertname: ContainerDown
    target_match:
      alertname: HighCPUUsage
    equal: ['instance']

  - source_match:
      alertname: ContainerDown
    target_match:
      alertname: HighMemoryUsage
    equal: ['instance']

  # –ï—Å–ª–∏ PostgreSQL down, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
  - source_match:
      alertname: PostgreSQLDown
    target_match:
      category: application
    equal: ['cluster']

  # –ï—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã–π –∞–ª–µ—Ä—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –ø–æ–¥–∞–≤–∏—Ç—å –º–µ–Ω–µ–µ —Å–µ—Ä—å–µ–∑–Ω—ã–µ
  - source_match:
      category: security
      severity: critical
    target_match:
      category: security
      severity: warning
    equal: ['instance']