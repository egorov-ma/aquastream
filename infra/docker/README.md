# Управление Docker-контейнерами проекта AquaStream

Набор скриптов для управления Docker-контейнерами проекта AquaStream.

## Структура каталогов

- **compose/** - Файлы Docker Compose (docker-compose.yml и docker-compose.override.yml)
- **scripts/** - Скрипты для управления контейнерами
- **images/** - Dockerfile-ы для сборки образов
- **documentation/** - Документация по скриптам

## Доступные скрипты

### Основные скрипты управления:

- **[scripts/start.sh](./scripts/start.sh)** - Запуск контейнеров
- **[scripts/stop.sh](./scripts/stop.sh)** - Остановка контейнеров
- **[scripts/restart.sh](./scripts/restart.sh)** - Перезапуск контейнеров с учетом зависимостей между сервисами
- **[scripts/check.sh](./scripts/check.sh)** - Проверка работоспособности и зависимостей сервисов
- **[scripts/api-check.sh](./scripts/api-check.sh)** - Быстрая проверка API и Frontend

### Дополнительные скрипты:

- **[scripts/logs.sh](./scripts/logs.sh)** - Просмотр логов
- **[scripts/status.sh](./scripts/status.sh)** - Мониторинг состояния контейнеров
- **[scripts/update.sh](./scripts/update.sh)** - Обновление кода и образов
- **[scripts/backup.sh](./scripts/backup.sh)** - Создание резервных копий

## Краткое руководство по использованию

Все скрипты имеют права на исполнение и могут запускаться напрямую:

Для запуска всех сервисов:
```bash
./scripts/start.sh
```

Для остановки всех сервисов:
```bash
./scripts/stop.sh
```

Для перезапуска всех сервисов:
```bash
./scripts/restart.sh -r -b
```

Для проверки состояния всех контейнеров:
```bash
./scripts/status.sh
```

Для быстрой проверки API и Frontend:
```bash
./scripts/api-check.sh
```

## Подробная документация

Подробную документацию по всем скриптам можно найти в файле [documentation/documentation.md](./documentation/documentation.md).

## Требования

- Docker 20.10.0 или выше
- Docker Compose v2.0.0 или выше

# Руководство по устранению проблем с контейнерами Docker

В этом документе описаны частые проблемы с Docker-контейнерами проекта Aquastream и способы их решения.

## Содержание
1. [Основные проблемы и их решения](#основные-проблемы-и-их-решения)
2. [Скрипты для автоматического исправления](#скрипты-для-автоматического-исправления)
3. [Ручное исправление проблем](#ручное-исправление-проблем)
4. [Полезные команды для диагностики](#полезные-команды-для-диагностики)

## Основные проблемы и их решения

### 1. Отсутствие библиотеки Logstash

**Симптомы**: 
* Контейнеры Java-сервисов запускаются и сразу останавливаются с кодом ошибки (1)
* В логах присутствуют сообщения вида: `ClassNotFoundException: net.logstash.logback.encoder.LogstashEncoder`

**Причина**: 
В проекте настроено логирование с использованием Logstash, но соответствующей зависимости нет в build.gradle файлах микросервисов.

**Решение**:
Добавьте в build.gradle каждого микросервиса следующую зависимость:
```gradle
implementation 'net.logstash.logback:logstash-logback-encoder:7.4'
```

### 2. Проблема с сетевыми алиасами

**Симптомы**:
* Frontend-контейнер не может подключиться к api-gateway
* В логах frontend присутствует ошибка: `host not found in upstream "api-gateway"`

**Причина**:
В конфигурации Docker Compose не настроены сетевые алиасы для контейнеров. Nginx в frontend пытается обратиться к хосту "api-gateway", но такого имени в сети Docker нет.

**Решение**:
В файле docker-compose.yml для сервиса api-gateway добавьте:
```yaml
networks:
  aquastream-network:
    aliases:
      - api-gateway
```

### 3. Проблема с порядком запуска сервисов

**Симптомы**:
* Микросервисы не могут подключиться к базе данных или Kafka
* Фронтенд не может подключиться к API Gateway

**Причина**:
Контейнеры запускаются в произвольном порядке без учета зависимостей между ними.

**Решение**:
Используйте обновленный скрипт restart.sh, который обеспечивает правильный порядок запуска:
```bash
./scripts/restart.sh -r -b
```

## Скрипты для автоматического исправления

В проекте добавлены следующие скрипты для быстрой диагностики и решения проблем:

### api-check.sh

Скрипт для быстрой проверки доступности API через frontend и напрямую:

```bash
./scripts/api-check.sh
```

Скрипт выполняет следующие проверки:
- Доступность frontend на порту 3000
- Проверка доступности API через frontend прокси
- Прямая проверка API на порту 8080
- Проверка сетевых настроек Docker
- Анализ конфигурации Nginx в контейнере frontend

## Полезные команды для диагностики

1. **Проверка статуса всех контейнеров**:
   ```
   docker ps -a
   ```

2. **Проверка сетей Docker**:
   ```
   docker network ls
   docker network inspect aquastream-network
   ```

3. **Запуск контейнера в интерактивном режиме**:
   ```
   docker-compose run --rm <имя_сервиса> /bin/bash
   ```

4. **Проверка логов всех контейнеров**:
   ```
   docker-compose logs
   ```

5. **Проверка конфигурации файла docker-compose.yml**:
   ```
   docker-compose config
   ```

---

Если у вас остаются проблемы после применения указанных решений, пожалуйста, создайте issue в репозитории проекта с подробным описанием проблемы и прикрепленными логами. 