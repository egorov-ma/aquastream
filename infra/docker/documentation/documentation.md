# Документация по скриптам управления Docker для проекта AquaStream

## Введение

Скрипты управления Docker позволяют легко запускать, останавливать, проверять и управлять всеми контейнерами проекта AquaStream. Они предоставляют удобный интерфейс командной строки, обеспечивают вывод с цветовой дифференциацией и обработку ошибок.

Все скрипты используют современный синтаксис `docker compose` (вместо устаревшего `docker-compose`) и подробные сообщения о состоянии операций.

### Системные требования

Для корректной работы скриптов требуются следующие минимальные версии:

- **Docker**: 24.0.0 или выше
- **Docker Compose**: 2.21.0 или выше

Некоторые функции могут быть недоступны в более старых версиях. Рекомендуется использовать последние стабильные версии Docker и Docker Compose.

Чтобы проверить установленные версии, выполните:
```bash
docker --version
docker compose version
```

Для обновления Docker рекомендуется использовать официальные инструкции с сайта Docker: https://docs.docker.com/engine/install/

### Общие функции для всех скриптов

- Вывод справки с использованием опции `-h` или `--help`
- Цветной вывод сообщений
- Возможность выборочного управления сервисами с помощью опции `-s` или `--service`
- Режим подробного вывода с опцией `--verbose`
- Единая схема возврата кодов ошибок

## Содержание

1. [Введение](#введение)
2. [Скрипты основного управления](#скрипты-основного-управления)
   - [start.sh](#startsh)
   - [stop.sh](#stopsh)
   - [restart.sh](#restartsh)
   - [check.sh](#checksh)
3. [Дополнительные скрипты](#дополнительные-скрипты)
   - [logs.sh](#logssh)
   - [status.sh](#statussh)
   - [update.sh](#updatesh)
   - [backup.sh](#backupsh)
4. [Типичные сценарии использования](#типичные-сценарии-использования)
5. [Советы и рекомендации](#советы-и-рекомендации)
6. [Устранение неполадок](#устранение-неполадок)

## Скрипты основного управления

### start.sh

**Описание**: Запуск Docker-контейнеров проекта.

**Использование**:
```
./start.sh [опции]
```

**Опции**:
- `-h, --help` - Показать справку
- `-s, --service СЕРВИС` - Запустить только указанный сервис (например: frontend, api-gateway)
- `-b, --build` - Пересобрать образы перед запуском
- `-v, --verbose` - Подробный вывод
- `-d, --detach` - Запустить контейнеры в фоновом режиме (по умолчанию)
- `-a, --attach` - Запустить контейнеры в интерактивном режиме (не в фоне)

**Примеры**:
```bash
# Запустить все сервисы
./start.sh

# Запустить только frontend
./start.sh -s frontend

# Пересобрать и запустить только api-gateway
./start.sh -b -s api-gateway

# Запустить все сервисы в интерактивном режиме
./start.sh -a
```

### stop.sh

**Описание**: Остановка Docker-контейнеров проекта.

**Использование**:
```
./stop.sh [опции]
```

**Опции**:
- `-h, --help` - Показать справку
- `-s, --service СЕРВИС` - Остановить только указанный сервис (например: frontend, api-gateway)
- `-r, --remove` - Удалить контейнеры после остановки (эквивалент docker compose down)
- `-v, --volumes` - Удалить также и тома (только вместе с -r)
- `-a, --all` - Удалить все неиспользуемые контейнеры, сети и образы (очистка)
- `--verbose` - Подробный вывод

**Примеры**:
```bash
# Остановить все сервисы
./stop.sh

# Остановить только frontend
./stop.sh -s frontend

# Остановить и удалить контейнеры
./stop.sh -r

# Остановить и удалить контейнеры вместе с томами
./stop.sh -r -v

# Остановить контейнеры и выполнить полную очистку
./stop.sh -a
```

### restart.sh

**Описание**: Перезапуск Docker-контейнеров проекта с возможностью пересборки образов и проверкой работоспособности.

**Использование**:
```
./restart.sh [опции]
```

**Опции**:
- `-h, --help` - Показать справку
- `-s, --service СЕРВИС` - Перезапустить только указанный сервис (например: frontend, api-gateway)
- `-b, --build` - Пересобрать образы перед запуском
- `-c, --skip-check` - Пропустить проверку работоспособности после запуска
- `-r, --remove` - Удалить контейнеры при остановке (эквивалент docker compose down)
- `-v, --volumes` - Удалить также и тома (только вместе с -r)
- `-p, --prune` - Удалить неиспользуемые контейнеры, сети и образы после перезапуска
- `-t, --timeout N` - Таймаут между попытками проверки (по умолчанию: 5 секунд)
- `-a, --attempts N` - Количество попыток проверки (по умолчанию: 3)
- `--verbose` - Подробный вывод

**Примеры**:
```bash
# Перезапустить все сервисы
./restart.sh

# Перезапустить только frontend
./restart.sh -s frontend

# Пересобрать образы перед перезапуском
./restart.sh -b

# Пересобрать и перезапустить только frontend
./restart.sh -s frontend -b

# Перезапустить, удалив контейнеры и тома
./restart.sh -r -v

# Перезапустить и выполнить очистку системы
./restart.sh -p
```

### check.sh

**Описание**: Проверка работоспособности Docker-контейнеров проекта.

**Использование**:
```
./check.sh [опции]
```

**Опции**:
- `-h, --help` - Показать справку
- `-s, --service СЕРВИС` - Проверить только указанный сервис (например: frontend, api-gateway)
- `-t, --timeout СЕКУНДЫ` - Таймаут между попытками проверки (по умолчанию: 5 секунд)
- `-a, --attempts ЧИСЛО` - Количество попыток проверки (по умолчанию: 3)
- `-v, --verbose` - Подробный вывод
- `-p, --ping` - Проверить доступность сервисов через HTTP/HTTPS
- `-l, --logs` - Показать логи контейнеров при ошибке

**Примеры**:
```bash
# Проверить все сервисы
./check.sh

# Проверить только frontend
./check.sh -s frontend

# Проверить все сервисы, включая HTTP-проверку
./check.sh -p

# Проверить с таймаутом 10 секунд и 5 попытками
./check.sh -t 10 -a 5

# Проверить с подробным выводом и логами при ошибке
./check.sh -v -l
```

## Дополнительные скрипты

### logs.sh

**Описание**: Просмотр логов Docker-контейнеров проекта.

**Использование**:
```
./logs.sh [опции]
```

**Опции**:
- `-h, --help` - Показать справку
- `-s, --service СЕРВИС` - Показать логи только указанного сервиса (например: frontend, api-gateway)
- `-f, --follow` - Следить за логами в реальном времени
- `-n, --lines ЧИСЛО` - Количество строк для отображения (по умолчанию: 100)
- `-t, --timestamps` - Показывать метки времени для каждой строки лога
- `--since ВРЕМЯ` - Показать логи с указанного времени (например: 10m, 1h, 2023-01-01)
- `--until ВРЕМЯ` - Показать логи до указанного времени
- `--tail` - Показать только последние строки (эквивалент -n)
- `--no-color` - Отключить цветной вывод
- `--grep ТЕКСТ` - Фильтровать логи, содержащие указанный текст

**Примеры**:
```bash
# Показать последние 100 строк логов frontend
./logs.sh -s frontend

# Следить за логами API шлюза в реальном времени
./logs.sh -s api -f

# Показать последние 500 строк логов сервиса пользователей
./logs.sh -s user -n 500

# Показать логи всех сервисов за последние 30 минут
./logs.sh --since 30m

# Показать строки с ошибками в логах Kafka
./logs.sh -s kafka --grep Error
```

### status.sh

**Описание**: Получение детальной информации о состоянии Docker-контейнеров и ресурсов проекта.

**Использование**:
```
./status.sh [опции]
```

**Опции**:
- `-h, --help` - Показать справку
- `-s, --service СЕРВИС` - Показать статус только указанного сервиса (например: frontend, api-gateway)
- `-d, --detailed` - Показать подробную информацию о ресурсах
- `-n, --network` - Показать информацию о сетевых подключениях
- `-v, --volumes` - Показать информацию о подключенных томах
- `-p, --processes` - Показать информацию о процессах внутри контейнеров
- `-a, --all` - Показать всю доступную информацию (комбинация всех опций)
- `--json` - Вывод в формате JSON (для интеграции с другими инструментами)
- `--health` - Проверить доступность HTTP эндпоинтов сервисов

**Примеры**:
```bash
# Показать базовый статус всех сервисов
./status.sh

# Показать подробную информацию о frontend
./status.sh -s frontend -d

# Показать всю доступную информацию о сервисах
./status.sh -a

# Проверить доступность сервисов через HTTP
./status.sh --health
```

### update.sh

**Описание**: Обновление кода проекта и Docker-образов.

**Использование**:
```
./update.sh [опции]
```

**Опции**:
- `-h, --help` - Показать справку
- `-s, --service СЕРВИС` - Обновить только указанный сервис (например: frontend, api-gateway)
- `-b, --branch ВЕТКА` - Обновить до указанной ветки Git (по умолчанию: main)
- `-t, --tag ТЕГ` - Обновить до указанной версии/тега
- `-p, --pull-only` - Только получить обновления из репозитория, без пересборки и перезапуска
- `-r, --restart` - Перезапустить сервисы после обновления
- `-f, --force` - Принудительное обновление (сброс локальных изменений)
- `--skip-pull` - Пропустить этап получения обновлений из репозитория
- `--no-cache` - Не использовать кеш при сборке образов

**Примеры**:
```bash
# Обновить весь проект до последней версии в ветке main
./update.sh

# Обновить проект до последней версии в ветке develop
./update.sh -b develop

# Обновить только frontend
./update.sh -s frontend

# Обновить до указанной версии/тега
./update.sh -t v1.2.3

# Обновить и перезапустить сервисы
./update.sh -r
```

### backup.sh

**Описание**: Создание резервных копий данных проекта (баз данных и томов).

**Использование**:
```
./backup.sh [опции]
```

**Опции**:
- `-h, --help` - Показать справку
- `-s, --service СЕРВИС` - Сделать резервную копию только указанного сервиса (например: postgres)
- `-o, --output DIR` - Директория для сохранения резервных копий (по умолчанию: ./backups)
- `-c, --compress` - Сжать резервные копии для экономии места
- `-d, --db-only` - Резервное копирование только баз данных
- `-v, --volumes-only` - Резервное копирование только томов
- `-f, --filename ИМЯ` - Пользовательское имя файла резервной копии
- `-n, --no-timestamp` - Не добавлять временную метку к имени резервной копии

**Примеры**:
```bash
# Резервное копирование всех данных
./backup.sh

# Резервное копирование только PostgreSQL
./backup.sh -s postgres

# Резервное копирование с компрессией
./backup.sh -c

# Сохранить резервные копии в указанной директории
./backup.sh -o /mnt/backups
```

## Типичные сценарии использования

### Начало работы с проектом

```bash
# Запуск всего проекта
./start.sh -b

# Проверка состояния после запуска
./check.sh -p
```

### Повседневная разработка

```bash
# Проверка статуса
./status.sh

# Перезапуск конкретного сервиса после внесения изменений
./restart.sh -s frontend -b

# Просмотр логов
./logs.sh -s frontend -f
```

### Обновление проекта

```bash
# Получение обновлений и перезапуск
./update.sh -r

# Проверка статуса после обновления
./status.sh --health
```

### Профилактическое обслуживание

```bash
# Полный перезапуск с очисткой неиспользуемых ресурсов
./restart.sh -r -p

# Создание резервной копии данных
./backup.sh -c
```

## Советы и рекомендации

1. **Используйте скрипт status.sh регулярно** - он даст полное представление о состоянии вашей системы.

2. **Настройте планировщик для автоматических резервных копий** - например, для ежедневного резервного копирования:
   ```bash
   # Добавить в crontab
   0 3 * * * /путь/к/проекту/infra/docker/backup.sh -c -o /path/to/backup/dir
   ```

3. **При изменении кода всегда проверяйте логи** - используйте `logs.sh -f` во время тестирования для отслеживания изменений в реальном времени.

4. **Используйте опцию `-s` для фокусировки на конкретном сервисе** - это ускоряет процесс разработки и отладки, позволяя работать только с нужным сервисом.

5. **Для CI/CD интеграции** - скрипты поддерживают неинтерактивный режим и коды возврата для интеграции с системами непрерывной интеграции.

## Устранение неполадок

### Общие проблемы и решения

1. **Контейнеры не запускаются**
   - Проверьте свободное место: `df -h`
   - Проверьте доступные порты: `netstat -tulpn | grep <port>`
   - Просмотрите логи: `./logs.sh`

2. **Ошибки связности между сервисами**
   - Проверьте состояние сети: `./status.sh -n`
   - Убедитесь, что все зависимые сервисы запущены: `./check.sh -p`

3. **Ошибки при обновлении**
   - Проверьте локальные изменения: `git status`
   - Попробуйте принудительное обновление: `./update.sh -f`

4. **Проблемы с производительностью**
   - Проверьте использование ресурсов: `./status.sh -d`
   - Посмотрите активные процессы: `./status.sh -p`

### Журналы ошибок

- Все скрипты записывают ошибки в файл лога:
  - `restart.sh` сохраняет лог в `infra/docker/restart.log`

### Логи Docker

Для более глубокого анализа можно использовать встроенные команды Docker:

```bash
# Проверка всех Docker-контейнеров
docker ps -a

# Проверка всех Docker-образов
docker images

# Проверка использования дискового пространства Docker
docker system df
```

## Локализация ошибок в скриптах

Если при запуске скриптов возникают ошибки, воспользуйтесь следующими методами для их локализации:

### 1. Запуск скрипта в режиме отладки

Bash предоставляет встроенный отладчик, который выводит каждую выполняемую команду:

```bash
# Запуск с выводом всех выполняемых команд
bash -x ./имя_скрипта.sh [опции]
```

Это поможет увидеть, на какой именно команде происходит ошибка.

### 2. Проверка совместимости флагов с вашей версией Docker

Некоторые флаги могут не поддерживаться в вашей версии Docker или Docker Compose. Проверьте версию:

```bash
docker --version
docker compose version
```

### 3. Типичные ошибки и их решения

- **Ошибка "unknown flag: --quiet-pull"**: 
  Этот флаг присутствует в документации Docker Compose, но не работает корректно в некоторых версиях. Скрипт `start.sh` теперь не использует этот флаг до его исправления в Docker.

- **Ошибка "Can't find a suitable configuration file"**:
  Проверьте наличие файлов docker-compose.yml и docker-compose.override.yml в той же директории, что и скрипт.

- **Ошибка "Permission denied"**:
  Убедитесь, что скрипты имеют права на выполнение:
  ```bash
  chmod +x *.sh
  ```

- **Ошибка "No such service: <имя-сервиса>"**:
  Проверьте, что имя сервиса указано правильно и существует в docker-compose.yml файле.

### 4. Проверка состояния системы Docker

Иногда проблемы могут быть вызваны общими проблемами с Docker:

```bash
# Проверка состояния Docker 
docker info

# Перезапуск Docker (для MacOS/Windows)
# Используйте интерфейс Docker Desktop или команду:
osascript -e 'quit app "Docker"' && open -a Docker
```

### 5. Дополнительные команды для диагностики

```bash
# Проверить, что Docker сервисы корректно описаны
docker compose config

# Проверить, что все необходимые порты свободны
netstat -tulpn | grep <номер_порта>

# Посмотреть, какие ресурсы использует Docker
docker system df -v
```

Если ошибки сохраняются после использования этих методов, рекомендуется обратиться к официальной документации Docker или описать проблему более подробно. 