# Документация проекта AquaStream

Эта документация описывает архитектуру проекта, назначение каждого модуля, используемые технологии, конфигурации, а также процессы сборки, развертывания и мониторинга. Документация находится непосредственно в проекте и предназначена для разработчиков, администраторов и DevOps-инженеров.

---

## 1. Введение

**AquaStream** — микросервисная платформа для организации и управления сплавами. Система включает в себя ряд отдельных сервисов, каждый из которых выполняет свою функцию, обеспечивая:
- Управление пользователями и аутентификацию
- Планирование сплавов с расчетом маршрутов и оценкой сложности
- Управление экипажами
- Отправку уведомлений
- Централизованную маршрутизацию входящих запросов через API Gateway
- Удобный веб-интерфейс для конечных пользователей

---

## 2. Архитектура проекта

Проект построен на **микросервисной архитектуре**. Основные компоненты включают:

- **API Gateway (backend-gateway):**
  - Централизованная точка входа.
  - Маршрутизация запросов к микросервисам.
  - Реализация паттернов: Circuit Breaker, Request Rate Limiter, Retry.
  - Поддержка как локальных, так и production-конфигураций (SSL, load balancing через lb://).

- **User Service (backend-user):**
  - Регистрация и аутентификация пользователей.
  - Управление данными пользователей.
  - Использование JWT для обеспечения безопасности.
  
- **Event Service (backend-event):**
  - Управление событиями сплавов (ранее Planning Service).
  - Планирование сплавов, расчёт маршрутов и оценка их сложности.
  - Поддержка gRPC API с использованием Protobuf.
  - Включение gRPC Reflection для автоматической генерации схемы API.

- **Crew Service (backend-crew):**
  - Управление экипажами сплава.
  - Работа с базой данных через Spring Data JPA и PostgreSQL.
  
- **Notification Service (backend-notification):**
  - Отправка уведомлений, интеграция с Kafka.
  
- **Frontend:**
  - Современный веб-интерфейс для взаимодействия с системой.
  - Сборка через npm, возможно на базе React или аналогичного фреймворка.

- **Common:**
  - Общие библиотеки, утилиты и конфигурации (например, файл `db-common.yml` для подключения к PostgreSQL).

- **Infrastructure (Infra):**
  - Скрипты и файлы для развертывания (Dockerfile-ы, docker-compose, Kubernetes-манифесты).
  - CI/CD пайплайн (GitHub Actions).
  - Скрипты резервного копирования и мониторинга.

---

## 3. Описание модулей

### 3.1. API Gateway (backend-gateway)
- **Назначение:**  
  Централизует входящие запросы и рассылает их по соответствующим микросервисам.
  
- **Технологии:**  
  Spring Boot, Spring Cloud Gateway, Netflix Eureka Client, Resilience4j для Circuit Breaker, Request Rate Limiter и Retry.
  
- **Конфигурация:**  
  - Локальная: `application.yml`
  - Docker: `application-docker.yml`
  - Production: `application-prod.yml` (SSL, load balancing через lb://, подробные фильтры)
  
- **Особенности:**  
  - Реализован fallback для Circuit Breaker.
  - Использование управляемых маршрутов для сервисов: User, Planning, Crew, Notification.

---

### 3.2. User Service (backend-user)
- **Назначение:**  
  Регистрация, аутентификация, управление профилями пользователей.
  
- **Технологии:**  
  Spring Boot, Spring Data JPA, Spring Security, JWT.
  
- **Конфигурация:**  
  - Локальная: `application.yml`
  - Docker: `application-docker.yml` с импортом настроек из `db-common.yml`
  - JWT параметры (секрет и время жизни токена) задаются через переменные окружения.
  
- **Особенности:**  
  - Документация REST API через Swagger UI.
  - Поддержка управления сессиями и безопасного доступа.

---

### 3.3. Event Service (backend-event)
- **Назначение:**  Управление событиями сплавов (ранее Planning Service).

- **Технологии:**  
  Spring Boot, gRPC, Protocol Buffers, Spring Actuator.
  
- **Конфигурация:**  
  - Локальная и Docker: `application.yml` / `application-docker.yml`
  - Генерация кода из Proto файлов настроена в `build.gradle` через плагин Protobuf.
  
- **Особенности:**  
  - Поддержка gRPC Reflection.
  - Возможность тестирования через утилиту `grpcui`.

---

### 3.4. Crew Service (backend-crew)
- **Назначение:**  
  Управление экипажами, распределение задач внутри сплава.
  
- **Технологии:**  
  Spring Boot, Spring Data JPA, Netflix Eureka Client, Spring Actuator.
  
- **Конфигурация:**  
  - Docker: `application-docker.yml` с импортом `db-common.yml`
  - Дополнительные настройки для мониторинга и метрик (Actuator, Prometheus).
  
- **Особенности:**  
  - Централизованное логирование и мониторинг с помощью Actuator endpoints.

---

### 3.5. Notification Service (backend-notification)
- **Назначение:**  
  Отправка уведомлений пользователям о различных событиях.
  
- **Технологии:**  
  Spring Boot, Kafka, Spring Actuator.
  
- **Конфигурация:**  
  - Docker: `application-docker.yml` с импортом `db-common.yml` (при необходимости)
  - Настройка Kafka через переменные окружения.
  
- **Особенности:**  
  - Интеграция с message broker для асинхронной обработки уведомлений.
  - Мониторинг через Spring Actuator.

---

### 3.6. Frontend
- **Назначение:**  
  Предоставление удобного веб-интерфейса для работы с системой.
  
- **Технологии:**  
  Node.js, npm, современный фреймворк (например, React или Vue).
  
- **Сборка:**  
  Скрипт `build.sh` выполняет `npm install` и `npm run build` для сборки.
  
- **Особенности:**  
  - UI интегрируется с Back-End через API Gateway.
  - Документация по использованию и API может быть доступна непосредственно через интерфейс.

---

### 3.7. Common
- **Назначение:**  
  Общие модули, утилиты, модели и конфигурации для всех микросервисов.
  
- **Содержимое:**  
  - `db-common.yml` — общий файл конфигурации для подключения к PostgreSQL.
  - Дополнительные библиотеки и утилиты, переиспользуемые в различных сервисах.

---

### 3.8. Infra
- **Назначение:**  
  Обеспечивает инфраструктурную поддержку проекта и включает:
  
- **Docker:**  
  - Dockerfile-ы для каждого микросервиса (находятся в `infra/docker`).
  - Файл `docker-compose.yml`, который оркестрирует контейнеры для микросервисов, базы данных и Kafka.
  - Контейнер Prometheus теперь пробрасывает порт 9090 на внешний порт 9091, что позволяет избежать конфликтов (доступ по http://localhost:9091).
  - Скрипты:  
    - `start.sh` — сборка и запуск контейнеров.
    - `stop.sh` — остановка контейнеров.
    - `restart.sh` — перезапуск контейнеров.
  
- **CI/CD:**
  - Конфигурация GitHub Actions описана в `ci-cd/README.md`. Публикация Docker-образов и их запуск через `docker compose`.
  - Деплой на production будет реализован позднее скриптом bash/Ansible (Kubernetes не используется в MVP).
  
- **Резервное копирование:**  
  - Скрипт `backup.sh` для резервного копирования базы данных с использованием `pg_dump`, ротации и загрузки в AWS S3.
  
- **Мониторинг и логирование:**  
  - Prometheus (`prometheus.yml`) собирает метрики со всех сервисов.
  - Grafana дашборды (например, `grafana-dashboard.json`) для визуализации метрик.
  - Централизованное логирование через Logback, настроенное в `logback-spring.xml` для отправки логов в ELK.

---

## 4. Инфраструктура и DevOps

### 4.1. Docker и контейнеризация
- **Файл `docker-compose.yml`:**  
  Определяет контейнеры для:
  - API Gateway
  - User Service
  - Planning Service (включая gRPC порт 9090)
  - Crew Service
  - Notification Service
  - Дополнительных сервисов (PostgreSQL, Kafka)
  
- **Скрипты управления:**  
  - `start.sh` — сборка и запуск контейнеров.
  - `stop.sh` — остановка и удаление контейнеров.
  
- **Healthcheck:**  
  Каждый контейнер имеет настроенный healthcheck для контроля работоспособности.

### 4.2. CI/CD
- **GitHub Actions (.github/workflows/ci-cd.yml):**  
  - Этапы: тестирование (JUnit), сборка (Gradle), создание Docker-образов, деплой на production.
  - Деплой осуществляется через kubectl, используя предоставленный KUBECONFIG.

### 4.3. Мониторинг и логирование
- **Мониторинг:**  
  - Prometheus собирает метрики с endpoints `/actuator/prometheus`.
  - Grafana визуализирует показатели (например, JVM Memory Usage).
  
- **Логирование:**  
  - Logback с LogstashEncoder отправляет логи в консоль и в удаленную систему (например, ELK).

### 4.4. Резервное копирование
- **Скрипт `backup.sh`:**  
  - Выполняет резервное копирование базы данных PostgreSQL.
  - Реализует ротацию файлов (удаляет бэкапы старше 7 дней).
  - Загружает бэкапы в облачное хранилище (AWS S3).

---

## 5. Настройка и запуск проекта

### 5.1. Локальная сборка и запуск
- Перед запуском убедитесь, что в корневой папке присутствует файл `settings.gradle`.
- Для сборки используйте скрипт `build.sh`, который:
  - Собирает backend через Gradle (`./gradlew clean build`).
  - Собирает frontend с использованием npm (`npm install` и `npm run build`).
- Запуск микросервисов можно выполнить через `docker-compose up -d` из директории `infra/docker`.

### 5.2. Конфигурационные файлы
- Каждый модуль имеет:
  - Локальную конфигурацию (`application.yml`).
  - Конфигурацию для Docker (`application-docker.yml`).
  - Production-конфигурацию (например, для API Gateway — `application-prod.yml`).
- Общие настройки подключения к базе данных находятся в `common/src/main/resources/db-common.yml`.

---

## 6. Рекомендации и лучшие практики

- **Безопасность:**  
  - Храните конфиденциальные параметры (JWT секрет, пароли, SSL настройки) в переменных окружения.
  - Используйте production-конфигурации с SSL/TLS.
  
- **Масштабируемость и отказоустойчивость:**  
  - Микросервисная архитектура облегчает масштабирование отдельных компонентов.
  - Healthcheck и мониторинг обеспечивают оперативное обнаружение проблем.
  
- **Автоматизация:**  
  - CI/CD пайплайн автоматизирует тестирование, сборку и деплой.
  - Скрипты для управления контейнерами и резервного копирования упрощают эксплуатацию.
  
- **Поддерживаемость:**  
  - Централизованное логирование и мониторинг помогают быстро находить и решать проблемы.
  - Общий модуль (Common) позволяет переиспользовать конфигурацию и утилиты.

---

## 7. Документация API

### 7.1. REST API
- **User, Crew, Notification Services** предоставляют REST API.
- **Swagger UI:**  
  - Примеры доступа:  
    - User Service: [http://localhost:8081/swagger-ui.html](http://localhost:8081/swagger-ui.html)
    - Crew Service: [http://localhost:8083/swagger-ui.html](http://localhost:8083/swagger-ui.html)
    - Notification Service: [http://localhost:8084/swagger-ui.html](http://localhost:8084/swagger-ui.html)

### 7.2. gRPC API
- **Planning Service:**  
  - Реализует gRPC API, описание которого находится в `planning.proto` (директория `backend-event/src/main/proto/planning.proto`).
  - Для тестирования и визуализации используйте `grpcui`:
    - Локально: `grpcui -plaintext localhost:9090`
    - Через Docker: запустите соответствующий контейнер.

---

## 8. Дополнительные сведения

- **Контроль версий и зависимости:**  
  - Все версии зависимостей (например, grpcVersion, springCloudVersion) определены в файлах `build.gradle`.
  
- **Разработка и поддержка:**  
  - Регулярно обновляйте документацию в случае внесения изменений в архитектуру или функциональность.
  - При возникновении вопросов обращайтесь к разделу поддержки в документации проекта.

- **Контактная информация:**  
  - Для получения дополнительной информации или помощи свяжитесь с командой разработки (контакты могут быть указаны в соответствующем разделе проекта).

---

## 9. Заключение

Документация охватывает ключевые аспекты проекта AquaStream — от его архитектуры и описания модулей до инструкций по сборке, развертыванию и мониторингу. Она служит справочным материалом для всех участников проекта и будет регулярно обновляться по мере развития системы.

Регулярное обновление и поддержание документации поможет обеспечить высокое качество разработки и надежность эксплуатации проекта.

--- 

## Ссылки на подробные разделы
- System Analysis – `infra/docs/system-analysis/`
- Business Architecture – `infra/docs/business-architecture/`
- CI/CD – `infra/docs/ci-cd/`
- Дополнительные материалы – `infra/docs/other/` 