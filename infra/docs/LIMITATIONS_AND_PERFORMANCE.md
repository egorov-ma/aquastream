# Ограничения и производительность системы AquaStream

В данном документе описаны ограничения, рекомендуемые пороги производительности и масштабируемость микросервисной платформы AquaStream.

---

## 1. Общие ограничения системы

### 1.1. Предельные значения по нагрузке

| Параметр | Максимальное рекомендуемое значение | Примечание |
|----------|-------------------------------------|------------|
| Активные пользователи | 10,000 | Одновременные активные сессии |
| Запросов в секунду на API Gateway | 5,000 RPS | При наличии кэширования и балансировки |
| Количество одновременных сплавов | 1,000 | В активном состоянии |
| Размер экипажа для одного сплава | 100 человек | Обработка данных экипажа |
| Размер загружаемых файлов | 50 MB | Для фотографий и документов |
| Длина маршрута | 1,000 км | Максимальная длина одного маршрута |

### 1.2. Технические ограничения

#### 1.2.1. База данных PostgreSQL
- Максимальный размер БД: 1 TB
- Максимальное число одновременных подключений: 500
- Рекомендуемое время отклика запросов: <100 мс
- Операции записи: до 1,000 операций в секунду на сервис

#### 1.2.2. Kafka
- Размер сообщения: до 1 MB
- Retention period: 7 дней
- Максимальное количество партиций: 100 на топик
- Пропускная способность: до 10,000 сообщений в секунду

#### 1.2.3. API Gateway
- Таймаут соединения: 30 секунд
- Максимальный размер payload: 10 MB
- Rate limiting: 100 запросов в минуту на IP-адрес
- Circuit Breaker: срабатывает после 5 неудачных попыток

---

## 2. Ограничения по микросервисам

### 2.1. User Service (backend-user)
- Максимальное количество пользователей в системе: 1,000,000
- Максимальное количество ролей на пользователя: 10
- Время жизни JWT токена: 24 часа
- Refresh токен: 7 дней
- Максимальная нагрузка: 1,000 RPS
- Лимит неудачных попыток авторизации: 5 за 15 минут

### 2.2. Planning Service (backend-event)
- Максимальное количество сплавов в системе: 100,000
- Максимальное количество точек в маршруте: 5,000
- Максимальное количество типов сплавов: 50
- Максимальное время расчета сложного маршрута: 10 секунд
- Максимальная нагрузка на gRPC: 500 RPS

### 2.3. Crew Service (backend-crew)
- Максимальное количество экипажей: 10,000
- Максимальное количество участников в экипаже: 100
- Максимальное количество ролей в экипаже: 20
- Максимальная нагрузка: 500 RPS

### 2.4. Notification Service (backend-notification)
- Максимальная скорость отправки уведомлений: 1,000 в минуту
- Максимальное количество типов уведомлений: 50
- Максимальный размер текста уведомления: 5,000 символов
- Задержка доставки: не более 5 секунд

### 2.5. Frontend
- Рекомендуемый размер бандла: <2 MB
- Время загрузки первого контента (FCP): <2 секунды
- Время до интерактивности (TTI): <5 секунд
- Поддерживаемые браузеры: Chrome 80+, Firefox 75+, Safari 13+, Edge 80+
- Мобильная адаптация: разрешения от 320px до 1920px

---

## 3. Рекомендации по производительности

### 3.1. Оптимизация базы данных
- Рекомендуется использовать индексы для полей, участвующих в JOIN и WHERE условиях
- Партиционирование таблиц с историческими данными (логи, архивные сплавы) 
- Мониторинг медленных запросов и их оптимизация
- Настройка пула соединений: минимум 10, максимум 50 соединений

### 3.2. Кэширование
- Рекомендуется использовать кэширование для:
  - Данных пользователей (TTL: 10 минут)
  - Маршрутов сплавов (TTL: 1 час)
  - Статических данных (TTL: 24 часа)
- Рекомендуемые технологии: Redis или Caffeine

### 3.3. Оптимизация микросервисов
- Асинхронная обработка длительных операций
- Batch-обработка для массовых операций
- Правильная настройка пулов потоков
- Мониторинг использования памяти и CPU

### 3.4. Фронтенд
- Ленивая загрузка компонентов
- Оптимизация изображений
- Минификация и бандлинг ресурсов
- Использование CDN для статических ресурсов

---

## 4. Масштабируемость

### 4.1. Горизонтальное масштабирование
- Все сервисы поддерживают горизонтальное масштабирование
- Рекомендации по масштабированию для каждого сервиса:

| Сервис | Минимальное кол-во экземпляров | Рекомендуемое кол-во под нагрузкой |
|--------|--------------------------------|-----------------------------------|
| API Gateway | 2 | 3-5 |
| User Service | 2 | 3-4 |
| Planning Service | 2 | 3-6 |
| Crew Service | 1 | 2-3 |
| Notification Service | 2 | 3-4 |

### 4.2. Вертикальное масштабирование
- Рекомендуемые ресурсы для каждого сервиса:

| Сервис | Минимальные ресурсы | Рекомендуемые ресурсы |
|--------|---------------------|------------------------|
| API Gateway | 1 CPU, 2 GB RAM | 2 CPU, 4 GB RAM |
| User Service | 1 CPU, 2 GB RAM | 2 CPU, 4 GB RAM |
| Planning Service | 2 CPU, 4 GB RAM | 4 CPU, 8 GB RAM |
| Crew Service | 1 CPU, 2 GB RAM | 2 CPU, 4 GB RAM |
| Notification Service | 1 CPU, 2 GB RAM | 2 CPU, 4 GB RAM |
| PostgreSQL | 2 CPU, 4 GB RAM | 4 CPU, 8 GB RAM, SSD |
| Kafka | 2 CPU, 4 GB RAM | 4 CPU, 8 GB RAM |

### 4.3. Автомасштабирование
- Рекомендуемые метрики для автомасштабирования:
  - CPU: >70% в течение 2 минут
  - Memory: >80% в течение 2 минут
  - RPS: >80% от максимального значения в течение 1 минуты

---

## 5. Мониторинг производительности

### 5.1. Ключевые метрики

#### 5.1.1. Системные метрики
- Использование CPU и памяти
- Сетевой трафик
- Дисковые операции
- Длина очередей

#### 5.1.2. Бизнес-метрики
- Количество активных пользователей
- Количество активных сплавов
- Количество отправленных уведомлений
- Время расчета маршрутов

### 5.2. Алерты и оповещения
- Критические алерты:
  - Недоступность сервиса >30 секунд
  - Ошибки 5xx >1% от всех запросов
  - Время ответа API >500 мс для 90% запросов
  - Использование CPU >90% в течение 5 минут

- Предупреждающие алерты:
  - Время ответа API >300 мс для 90% запросов
  - Использование CPU >70% в течение 10 минут
  - Использование памяти >80% в течение 10 минут
  - Ошибки 4xx >5% от всех запросов

---

## 6. Рекомендации по оптимизации

### 6.1. Стратегии масштабирования при росте нагрузки
1. Оптимизация запросов к базе данных
2. Введение кэширования данных
3. Горизонтальное масштабирование сервисов
4. Шардирование базы данных при достижении лимитов
5. Интеграция с CDN для статического контента

### 6.2. Управление данными
- Архивация старых данных (сплавы старше 3 лет)
- Оптимизация хранения и доступа к часто используемым данным
- Реализация политики хранения и удаления данных

### 6.3. Оптимизация сетевого взаимодействия
- Минимизация межсервисных вызовов
- Использование эффективных форматов сериализации (Protocol Buffers)
- Балансировка нагрузки между сервисами

---

## 7. Планы развития

### 7.1. Планируемые улучшения производительности
- Внедрение GraphQL для оптимизации запросов с фронтенда
- Переход на реактивное программирование для высоконагруженных сервисов
- Оптимизация работы с базой данных через CQRS
- Внедрение масштабируемого хранилища для медиа-контента

### 7.2. Технические ограничения, требующие пересмотра
- Увеличение максимального размера загружаемых файлов
- Оптимизация обработки больших маршрутов
- Увеличение длительности хранения логов и истории
- Расширение возможностей аналитики и отчётности

---

## 8. Заключение

Соблюдение указанных ограничений и рекомендаций по производительности позволит поддерживать стабильную работу платформы AquaStream даже при значительном росте нагрузки. При достижении критических значений рекомендуется рассмотреть стратегии масштабирования и оптимизации, описанные в данном документе.

Данная документация должна обновляться по мере развития проекта и изменения его архитектуры. 